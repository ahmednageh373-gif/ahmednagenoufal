<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³ØªÙŠØ±Ø§Ø¯ AutoCAD - BIM App</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .importer-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .importer-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .step-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
        }
        
        .step-card.active {
            border: 2px solid #667eea;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        .step-card.completed {
            background: #d4edda;
            border-color: #28a745;
        }
        
        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        
        .step-card.completed .step-number {
            background: #28a745;
        }
        
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            background: #e9ecef;
            border-color: #5568d3;
        }
        
        .upload-area.dragover {
            background: #e7f3ff;
            border-color: #0066cc;
        }
        
        .file-input {
            display: none;
        }
        
        .progress-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: none;
        }
        
        .progress-container.active {
            display: block;
        }
        
        .progress-bar-wrapper {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .result-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .options-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .option-group {
            margin-bottom: 20px;
        }
        
        .option-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        
        .option-group label:hover {
            background: #f8f9fa;
        }
        
        .option-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="importer-container">
        <h1 style="text-align: center; color: #667eea; margin-bottom: 40px;">
            ğŸ—ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„ÙØ§Øª AutoCAD
        </h1>
        
        <!-- Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© -->
        <div class="importer-steps">
            <div class="step-card active" id="step1">
                <div class="step-number">1</div>
                <h3>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</h3>
                <p>DXF Ø£Ùˆ Excel</p>
            </div>
            
            <div class="step-card" id="step2">
                <div class="step-number">2</div>
                <h3>Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                <p>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
            
            <div class="step-card" id="step3">
                <div class="step-number">3</div>
                <h3>Ø§Ù„ØªØ­ÙˆÙŠÙ„</h3>
                <p>Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ 3D</p>
            </div>
            
            <div class="step-card" id="step4">
                <div class="step-number">4</div>
                <h3>Ø§Ù„Ø¬Ø§Ù‡Ø²</h3>
                <p>Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©</p>
            </div>
        </div>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹ -->
        <div class="upload-area" id="uploadArea">
            <input type="file" id="fileInput" class="file-input" accept=".dxf,.xlsx,.xls" multiple>
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“</div>
            <h2>Ø§Ø³Ø­Ø¨ Ø§Ù„Ù…Ù„ÙØ§Øª Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</h2>
            <p style="color: #666; margin-top: 10px;">
                Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: DXF, Excel (.xlsx, .xls)
            </p>
        </div>
        
        <!-- Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª -->
        <div class="options-panel" id="optionsPanel" style="display: none;">
            <h2>âš™ï¸ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯</h2>
            
            <div class="option-group">
                <label>
                    <input type="checkbox" id="optNormalizeUnits" checked>
                    <span>ØªÙˆØ­ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¥Ù„Ù‰ Ù…Ù„ÙŠÙ…ØªØ±</span>
                </label>
            </div>
            
            <div class="option-group">
                <label>
                    <input type="checkbox" id="optValidateData" checked>
                    <span>Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                </label>
            </div>
            
            <div class="option-group">
                <label>
                    <input type="checkbox" id="optExtractTables" checked>
                    <span>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„</span>
                </label>
            </div>
            
            <div class="option-group">
                <label>
                    <input type="checkbox" id="optConvertTo3D" checked>
                    <span>ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ 3D</span>
                </label>
            </div>
            
            <div class="option-group">
                <label>
                    <input type="checkbox" id="optDetectOpenings" checked>
                    <span>ÙƒØ´Ù Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ ÙˆØ§Ù„Ù†ÙˆØ§ÙØ°</span>
                </label>
            </div>
            
            <div class="option-group">
                <label>
                    <input type="checkbox" id="optApplySchedules" checked>
                    <span>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†Ø§ØµØ±</span>
                </label>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="startImport()">
                    ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                </button>
                <button class="btn btn-secondary" onclick="resetImport()">
                    ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
                </button>
            </div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
        <div class="progress-container" id="progressContainer">
            <h2 id="progressTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</h2>
            <div class="progress-bar-wrapper">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>
            <p id="progressMessage">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>
        </div>
        
        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="resultsContainer" style="display: none;">
            <h2 style="text-align: center; color: #28a745; margin-bottom: 30px;">
                âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­!
            </h2>
            
            <div class="results-grid">
                <div class="result-card">
                    <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©</h3>
                    <div class="result-item">
                        <span>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span>
                        <strong id="statFiles">0</strong>
                    </div>
                    <div class="result-item">
                        <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±:</span>
                        <strong id="statEntities">0</strong>
                    </div>
                    <div class="result-item">
                        <span>Ø§Ù„Ø·Ø¨Ù‚Ø§Øª:</span>
                        <strong id="statLayers">0</strong>
                    </div>
                    <div class="result-item">
                        <span>Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„:</span>
                        <strong id="statTables">0</strong>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ—ï¸ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙÙ†Ø´Ø£Ø©</h3>
                    <div class="result-item">
                        <span>ğŸ§± Ø¬Ø¯Ø±Ø§Ù†:</span>
                        <strong id="stat3DWalls">0</strong>
                    </div>
                    <div class="result-item">
                        <span>ğŸ›ï¸ Ø£Ø¹Ù…Ø¯Ø©:</span>
                        <strong id="stat3DColumns">0</strong>
                    </div>
                    <div class="result-item">
                        <span>ğŸ“ Ø¨Ù„Ø§Ø·Ø§Øª:</span>
                        <strong id="stat3DSlabs">0</strong>
                    </div>
                    <div class="result-item">
                        <span>ğŸšª Ø£Ø¨ÙˆØ§Ø¨ ÙˆÙ†ÙˆØ§ÙØ°:</span>
                        <strong id="stat3DOpenings">0</strong>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>ğŸ“‹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ù„Ù„Ø©</h3>
                    <div class="result-item">
                        <span>ğŸ¨ Ø¬Ø¯Ø§ÙˆÙ„ ØªØ´Ø·ÙŠØ¨Ø§Øª:</span>
                        <strong id="statFinishes">0</strong>
                    </div>
                    <div class="result-item">
                        <span>ğŸ”© Ø¬Ø¯Ø§ÙˆÙ„ ØªØ³Ù„ÙŠØ­:</span>
                        <strong id="statReinforcement">0</strong>
                    </div>
                    <div class="result-item">
                        <span>ğŸ“ Ø¬Ø¯Ø§ÙˆÙ„ Ø³Ù…Ø§ÙƒØ§Øª:</span>
                        <strong id="statThickness">0</strong>
                    </div>
                    <div class="result-item">
                        <span>ğŸ’° Ø¬Ø¯Ø§ÙˆÙ„ ÙƒÙ…ÙŠØ§Øª:</span>
                        <strong id="statBOQ">0</strong>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3>âš¡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                    <div class="result-item">
                        <span>Ø§Ù„ÙˆØ­Ø¯Ø§Øª:</span>
                        <strong id="statUnits">-</strong>
                    </div>
                    <div class="result-item">
                        <span>ÙˆÙ‚Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span>
                        <strong id="statTime">0 Ø«</strong>
                    </div>
                    <div class="result-item">
                        <span>Ù…Ù† Ø§Ù„ÙƒØ§Ø´:</span>
                        <strong id="statCache">Ù„Ø§</strong>
                    </div>
                    <div class="result-item">
                        <span>Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:</span>
                        <strong id="statErrors" style="color: #f00;">0</strong>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="viewIn3D()">
                    ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ 3D
                </button>
                <button class="btn btn-primary" onclick="downloadReport()">
                    ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                </button>
                <button class="btn btn-secondary" onclick="resetImport()">
                    ğŸ”„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>
    </div>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© -->
    <script src="DWGParser-Enhanced.js"></script>
    <script src="LayerExtractor.js"></script>
    <script src="2Dto3DConverter.js"></script>
    <script src="ScheduleParser.js"></script>
    
    <script>
        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
        let selectedFiles = [];
        let importResult = null;
        let startTime = null;
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±ÙØ¹
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        /**
         * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
         */
        function handleFiles(files) {
            selectedFiles = Array.from(files);
            
            if (selectedFiles.length === 0) return;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            document.getElementById('optionsPanel').style.display = 'block';
            uploadArea.style.display = 'none';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·ÙˆØ©
            setActiveStep(1);
            
            console.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${selectedFiles.length} Ù…Ù„Ù:`, selectedFiles.map(f => f.name));
        }
        
        /**
         * Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
         */
        async function startImport() {
            try {
                startTime = Date.now();
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                document.getElementById('optionsPanel').style.display = 'none';
                
                // Ø¹Ø±Ø¶ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                const progressContainer = document.getElementById('progressContainer');
                progressContainer.classList.add('active');
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                const options = {
                    normalizeUnits: document.getElementById('optNormalizeUnits').checked,
                    validateData: document.getElementById('optValidateData').checked,
                    extractTables: document.getElementById('optExtractTables').checked,
                    convertTo3D: document.getElementById('optConvertTo3D').checked,
                    detectOpenings: document.getElementById('optDetectOpenings').checked,
                    applySchedules: document.getElementById('optApplySchedules').checked,
                    onProgress: updateProgress
                };
                
                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ù†Ø¸Ù…Ø©
                const parser = new EnhancedDWGParser();
                const scheduleParser = new ScheduleParser();
                
                let allEntities = [];
                let allLayers = [];
                let allTables = [];
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ù…Ù„Ù
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const extension = file.name.split('.').pop().toLowerCase();
                    
                    updateProgress(
                        (i / selectedFiles.length) * 80,
                        `Ù…Ø¹Ø§Ù„Ø¬Ø© ${file.name}...`
                    );
                    
                    if (extension === 'dxf') {
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© DXF
                        setActiveStep(2);
                        const result = await parser.importFile(file, options);
                        
                        if (result.success) {
                            allEntities.push(...result.entities);
                            allLayers.push(...result.layers);
                            allTables.push(...result.tables);
                        }
                        
                    } else if (extension === 'xlsx' || extension === 'xls') {
                        // Ù…Ø¹Ø§Ù„Ø¬Ø© Excel
                        const tables = await scheduleParser.parseExcelFile(file);
                        allTables.push(...tables);
                    }
                }
                
                // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                updateProgress(85, 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„...');
                const schedules = await scheduleParser.parseAllSchedules(allTables, options);
                
                // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ 3D
                let converted3D = [];
                if (options.convertTo3D && allEntities.length > 0) {
                    setActiveStep(3);
                    updateProgress(90, 'ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ 3D...');
                    
                    const layerExtractor = new LayerExtractor(parser);
                    const converter = new TwoDToThreeDConverter(window.engine, layerExtractor);
                    
                    const conversionResult = await converter.convertAll(parser, options);
                    if (conversionResult.success) {
                        converted3D = conversionResult.elements;
                    }
                }
                
                // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
                if (options.applySchedules && converted3D.length > 0) {
                    updateProgress(95, 'ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„...');
                    scheduleParser.applySchedulesToElements(converted3D);
                }
                
                // Ø¥ÙƒÙ…Ø§Ù„
                setActiveStep(4);
                updateProgress(100, 'Ø§ÙƒØªÙ…Ù„!');
                
                // Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                importResult = {
                    files: selectedFiles.length,
                    entities: allEntities.length,
                    layers: allLayers.length,
                    tables: allTables.length,
                    converted3D: converted3D,
                    schedules: schedules,
                    time: ((Date.now() - startTime) / 1000).toFixed(2),
                    fromCache: false
                };
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                setTimeout(() => {
                    showResults();
                }, 500);
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯:', error);
                alert(`Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`);
                resetImport();
            }
        }
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
         */
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${Math.round(percent)}%`;
            progressMessage.textContent = message;
        }
        
        /**
         * ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ù†Ø´Ø·Ø©
         */
        function setActiveStep(step) {
            for (let i = 1; i <= 4; i++) {
                const stepCard = document.getElementById(`step${i}`);
                stepCard.classList.remove('active', 'completed');
                
                if (i < step) {
                    stepCard.classList.add('completed');
                } else if (i === step) {
                    stepCard.classList.add('active');
                }
            }
        }
        
        /**
         * Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
         */
        function showResults() {
            // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            document.getElementById('progressContainer').classList.remove('active');
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.style.display = 'block';
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            document.getElementById('statFiles').textContent = importResult.files;
            document.getElementById('statEntities').textContent = importResult.entities;
            document.getElementById('statLayers').textContent = importResult.layers;
            document.getElementById('statTables').textContent = importResult.tables;
            
            // Ø§Ù„Ø¹Ù†Ø§ØµØ± 3D
            const walls = importResult.converted3D.filter(e => e.type === 'wall').length;
            const columns = importResult.converted3D.filter(e => e.type === 'column').length;
            const slabs = importResult.converted3D.filter(e => e.type === 'slab').length;
            const openings = importResult.converted3D.filter(e => e.type === 'door' || e.type === 'window').length;
            
            document.getElementById('stat3DWalls').textContent = walls;
            document.getElementById('stat3DColumns').textContent = columns;
            document.getElementById('stat3DSlabs').textContent = slabs;
            document.getElementById('stat3DOpenings').textContent = openings;
            
            // Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
            document.getElementById('statFinishes').textContent = importResult.schedules.finishes.length;
            document.getElementById('statReinforcement').textContent = importResult.schedules.reinforcement.length;
            document.getElementById('statThickness').textContent = importResult.schedules.thickness.length;
            document.getElementById('statBOQ').textContent = importResult.schedules.boq.length;
            
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            document.getElementById('statUnits').textContent = 'Millimeters';
            document.getElementById('statTime').textContent = `${importResult.time} Ø«`;
            document.getElementById('statCache').textContent = importResult.fromCache ? 'Ù†Ø¹Ù…' : 'Ù„Ø§';
            document.getElementById('statErrors').textContent = '0';
        }
        
        /**
         * Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ 3D
         */
        function viewIn3D() {
            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ 3D
            window.location.href = 'index.html';
        }
        
        /**
         * ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
         */
        function downloadReport() {
            const report = {
                timestamp: new Date().toISOString(),
                summary: importResult,
                details: {
                    files: selectedFiles.map(f => f.name),
                    // ... ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±
                }
            };
            
            const dataStr = JSON.stringify(report, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `import-report-${Date.now()}.json`;
            link.click();
            
            alert('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        }
        
        /**
         * Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
         */
        function resetImport() {
            selectedFiles = [];
            importResult = null;
            
            document.getElementById('uploadArea').style.display = 'block';
            document.getElementById('optionsPanel').style.display = 'none';
            document.getElementById('progressContainer').classList.remove('active');
            document.getElementById('resultsContainer').style.display = 'none';
            
            fileInput.value = '';
            
            setActiveStep(1);
        }
    </script>
</body>
</html>
