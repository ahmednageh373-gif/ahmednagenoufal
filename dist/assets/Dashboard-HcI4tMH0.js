var w=(a,i,o)=>new Promise((m,c)=>{var u=n=>{try{h(o.next(n))}catch(x){c(x)}},N=n=>{try{h(o.throw(n))}catch(x){c(x)}},h=n=>n.done?m(n.value):Promise.resolve(n.value).then(u,N);h((o=o.apply(a,i)).next())});import{r as g,j as e}from"./react-vendor-D4cZjflF.js";import{B as W}from"./BoqAnalysisModal-DY_s_X_g.js";import{g as G,e as M,p as P}from"./index-Cogjp2r_.js";import{b as E,_ as U,U as H,p as Q,S as K,h as J,q as Y,o as Z}from"./icons-lib-DeXvYHHd.js";import"./vendor-DhnXlGBj.js";import"./vendor-large-CMFjXBcn.js";import"./genai-lib-BGDjQqRJ.js";import"./utils-lib-CuOuuFHP.js";const k=({title:a,value:i,icon:o,color:m,onClick:c})=>e.jsxs("div",{onClick:c,className:`bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 flex items-center gap-6 ${c?"cursor-pointer hover:shadow-lg hover:border-indigo-500":""}`,children:[e.jsx("div",{className:`p-4 rounded-full ${m}`,children:e.jsx(o,{className:"text-white",size:24})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 dark:text-gray-400",children:a}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 dark:text-white",children:i})]})]}),oe=({project:a,onSelectView:i,onUpdateFinancials:o,onUpdateSchedule:m,onUpdateWorkflow:c})=>{const u=a.data.schedule.length,N=a.data.schedule.filter(s=>s.progress===100).length,h=u>0?Math.round(N/u*100):0,n=a.data.financials.reduce((s,t)=>s+t.total,0),x=a.data.riskRegister.filter(s=>s.status==="Open").length,S=a.data.keyResults.length,X=S>0?Math.round(a.data.keyResults.reduce((s,t)=>{const d=t.targetValue>0?t.currentValue/t.targetValue*100:0;return s+Math.min(100,d)},0)/S):0,[q,p]=g.useState(!1),[D,v]=g.useState([]),[_,O]=g.useState(""),[T,B]=g.useState(!1),[b,R]=g.useState(!1),[f,C]=g.useState(!1),y=g.useRef(null),A=s=>w(null,null,function*(){var d;const t=(d=s.target.files)==null?void 0:d[0];if(t){B(!0),p(!0),O(t.name),v([]);try{const l=yield M(t);v(l)}catch(l){console.error("BOQ Analysis failed:",l),alert(`Failed to analyze BOQ: ${l.message}`),p(!1)}finally{B(!1)}y.current&&(y.current.value="")}}),F=(s,t,d)=>w(null,null,function*(){if(o(a.id,s,t),p(!1),d){R(!0);try{const l=yield P(s,a.startDate);l.length>0?(m(a.id,l),alert("تم إنشاء وتحديث الجدول الزمني بنجاح بناءً على المقايسة.")):alert("تم تحليل المقايسة ولكن لم يتم العثور على مهام لإنشاء جدول زمني.")}catch(l){alert(`فشل إنشاء الجدول الزمني: ${l.message}`)}finally{R(!1)}}}),L=()=>w(null,null,function*(){if(!(a.data.workflow.wbs&&!window.confirm("سيقوم الذكاء الاصطناعي بإنشاء هيكل تجزئة عمل (WBS) جديد. قد يتم استبدال أي هيكل حالي في قسم 'هيكلة العمل'. هل تريد المتابعة؟"))){C(!0);try{const s=yield G(a);c(a.id,{wbs:s}),alert('تم إنشاء هيكل تجزئة العمل بنجاح! يمكنك مراجعته وتعديله في قسم "هيكلة العمل".'),i("workflow")}catch(s){console.error("WBS Generation failed:",s),alert(`Failed to generate WBS: ${s.message}`)}finally{C(!1)}}}),$=()=>{window.print()},z=()=>{const s=a.data.schedule.filter(r=>r.status!=="Done").sort((r,I)=>new Date(r.start).getTime()-new Date(I.start).getTime()).slice(0,5).map(r=>({المهمة:r.name,"تاريخ البدء":r.start})),t=a.data.riskRegister.filter(r=>r.status==="Open"&&r.impact==="High").slice(0,5).map(r=>({الخطر:r.description,الاحتمالية:r.probability,التأثير:r.impact})),d=XLSX.utils.json_to_sheet(s),l=XLSX.utils.json_to_sheet(t),j=XLSX.utils.book_new();XLSX.utils.book_append_sheet(j,d,"Upcoming Tasks"),XLSX.utils.book_append_sheet(j,l,"Top Risks"),XLSX.writeFile(j,`dashboard_${a.name.replace(/\s/g,"_")}.xlsx`)};return e.jsxs("div",{className:"printable-area",children:[e.jsxs("header",{className:"mb-8 flex justify-between items-center flex-wrap gap-4 no-print",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"لوحة التحكم"}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:["نظرة عامة على مشروع: ",e.jsx("span",{className:"font-semibold",children:a.name})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:z,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(E,{size:18}),e.jsx("span",{children:"تصدير Excel"})]}),e.jsxs("button",{onClick:$,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(U,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]}),e.jsxs("button",{onClick:()=>{var s;return(s=y.current)==null?void 0:s.click()},disabled:b||f,className:"flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-slate-400",children:[b?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(H,{size:18}),e.jsx("span",{children:b?"جاري إنشاء الجدول...":"استيراد مقايسة"})]}),e.jsxs("button",{onClick:L,disabled:b||f,className:"flex items-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-slate-400",children:[f?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(Q,{size:18}),e.jsx("span",{children:f?"جاري الإنشاء...":"اقترح هيكل WBS (AI)"})]}),e.jsx("input",{type:"file",ref:y,onChange:A,accept:".xlsx, .xls, .csv",className:"hidden"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsx(k,{title:"تقدم الجدول الزمني",value:`${h}%`,icon:K,color:"bg-sky-500",onClick:()=>i("schedule")}),e.jsx(k,{title:"التكلفة الإجمالية",value:`${n.toLocaleString("ar-SA")} SAR`,icon:J,color:"bg-green-500",onClick:()=>i("financials")}),e.jsx(k,{title:"المخاطر المفتوحة",value:String(x),icon:Y,color:"bg-red-500",onClick:()=>i("risks")}),e.jsx(k,{title:"تقدم الأهداف (OKRs)",value:`${X}%`,icon:Z,color:"bg-indigo-500",onClick:()=>i("okrs")})]}),e.jsxs("div",{className:"mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"المهام القادمة"}),e.jsxs("div",{className:"space-y-3",children:[a.data.schedule.filter(s=>s.status!=="Done").sort((s,t)=>new Date(s.start).getTime()-new Date(t.start).getTime()).slice(0,5).map(s=>e.jsxs("div",{className:"p-3 bg-gray-50 dark:bg-gray-800 rounded-lg",children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["تاريخ البدء: ",s.start]})]},s.id)),a.data.schedule.filter(s=>s.status!=="Done").length===0&&e.jsx("p",{className:"text-gray-500",children:"لا توجد مهام قادمة."})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"أعلى المخاطر"}),e.jsxs("div",{className:"space-y-3",children:[a.data.riskRegister.filter(s=>s.status==="Open"&&s.impact==="High").slice(0,5).map(s=>e.jsxs("div",{className:"p-3 bg-red-50 dark:bg-red-900/30 rounded-lg",children:[e.jsx("p",{className:"font-medium",children:s.description}),e.jsxs("p",{className:"text-sm text-red-700 dark:text-red-300",children:["الاحتمالية: ",s.probability,", التأثير: ",s.impact]})]},s.id)),a.data.riskRegister.filter(s=>s.status==="Open"&&s.impact==="High").length===0&&e.jsx("p",{className:"text-gray-500",children:"لا توجد مخاطر عالية مفتوحة."})]})]})]}),e.jsx(W,{isOpen:q,onClose:()=>p(!1),onConfirm:F,financialItems:D,fileName:_,isLoading:T})]})};export{oe as Dashboard};
