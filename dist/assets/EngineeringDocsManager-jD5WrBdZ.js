var Y=Object.defineProperty,Z=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var te=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var L=(n,l,r)=>l in n?Y(n,l,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[l]=r,R=(n,l)=>{for(var r in l||(l={}))te.call(l,r)&&L(n,r,l[r]);if(B)for(var r of B(l))se.call(l,r)&&L(n,r,l[r]);return n},q=(n,l)=>Z(n,ee(l));var N=(n,l,r)=>new Promise((b,m)=>{var p=d=>{try{o(r.next(d))}catch(y){m(y)}},f=d=>{try{o(r.throw(d))}catch(y){m(y)}},o=d=>d.done?b(d.value):Promise.resolve(d.value).then(p,f);o((r=r.apply(n,l)).next())});import{r as x,j as e}from"./react-vendor-ITqvX6Xp.js";import{e as ae,p as ne,o as le}from"./index-CmtUYdlp.js";import{B as re}from"./BoqAnalysisModal-BDIHS9HL.js";import{X as ie,I as X,N as oe,O as de,V as ce,aj as me,U as ge,ai as $,F as xe}from"./icons-lib-BklrIGsN.js";import{v as P}from"./utils-lib-C_gzCXPI.js";import"./vendor-8CkhJSGZ.js";import"./vendor-large-gsDFeA65.js";import"./genai-lib-pAIF5Ws4.js";const pe=({isOpen:n,onClose:l,onSubmit:r,categoryName:b,isLoading:m})=>{const[p,f]=x.useState(""),o=d=>{d.preventDefault(),!(!p.trim()||m)&&r(p)};return n?e.jsx("div",{className:"modal",style:{display:"block"},onClick:l,children:e.jsxs("div",{className:"modal-content p-8 max-w-2xl dark:bg-gray-800",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:["إنشاء مسودة: ",b]}),e.jsx("button",{onClick:l,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(ie,{size:24})})]}),e.jsxs("form",{onSubmit:o,children:[e.jsx("p",{className:"mb-4 text-slate-600 dark:text-slate-400",children:"صف للذكاء الاصطناعي المستند الذي ترغب في إنشائه. كن محدداً قدر الإمكان."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"docPrompt",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"وصف المستند المطلوب"}),e.jsx("textarea",{id:"docPrompt",value:p,onChange:d=>f(d.target.value),required:!0,rows:5,placeholder:"مثال: قم بإنشاء مواصفات فنية لأعمال الخرسانة المسلحة لمبنى سكني من 5 طوابق، مع التركيز على جودة المواد ونسب الخلط.",className:"w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:l,className:"px-4 py-2 rounded-lg text-slate-700 dark:text-slate-200 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:m,className:"px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 flex items-center gap-2 disabled:bg-gray-400",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"جارٍ الإنشاء..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(X,{size:18}),e.jsx("span",{children:"إنشاء المسودة"})]})})]})]})]})}):null},ve=({project:n,onUpdateDocuments:l,onUpdateFinancials:r,onUpdateSchedule:b})=>{var z;const m=n.data.engineeringDocs||[],p=x.useRef(null),f=x.useRef(null),[o,d]=x.useState(((z=m[0])==null?void 0:z.id)||null),[y,w]=x.useState(!1),[A,v]=x.useState(!1),[M,D]=x.useState([]),[G,E]=x.useState(""),[_,C]=x.useState(!1),[T,F]=x.useState(!1),[k,I]=x.useState(!1),[j,O]=x.useState(!1),c=m.find(t=>t.id===o),Q=t=>N(null,null,function*(){var i;const a=(i=t.target.files)==null?void 0:i[0];if(!(!a||!o)){if(a.type.includes("spreadsheet")||a.type.includes("excel")||a.name.endsWith(".csv")){C(!0),w(!0),E(a.name),D([]);try{const s=yield ae(a);D(s)}catch(s){console.error("BOQ Analysis failed:",s),alert(`Failed to analyze BOQ: ${s.message}`),w(!1)}finally{C(!1)}}else{const s={id:`doc-${Date.now()}`,title:a.name,content:`File uploaded on ${new Date().toLocaleDateString()}`,lastUpdated:new Date().toISOString(),file:{name:a.name,url:URL.createObjectURL(a),type:a.type}};U(o,s)}p.current&&(p.current.value="")}}),J=t=>N(null,null,function*(){const a=t.target.files;if(!(!a||a.length===0)){O(!0);try{let i=JSON.parse(JSON.stringify(m));const s=new Map;i.forEach(g=>s.set(g.name,g));for(const g of Array.from(a)){if(!g.webkitRelativePath)continue;const S=g.webkitRelativePath.split("/");let h;if(S.length>2){const u=S[S.length-2];h=s.get(u),h||(h={id:`cat-${P()}`,name:u,documents:[]},i.push(h),s.set(u,h))}else o&&(h=i.find(u=>u.id===o));if(h){const u={id:`doc-${P()}`,title:g.name,content:`File uploaded on ${new Date().toLocaleDateString()}`,lastUpdated:new Date().toISOString(),file:{name:g.name,url:URL.createObjectURL(g),type:g.type}};h.documents.push(u)}}l(n.id,i)}catch(i){console.error("Folder upload failed:",i),alert(`Folder upload failed: ${i.message}`)}finally{O(!1),t.target&&(t.target.value="")}}}),U=(t,a)=>{const i=m.map(s=>s.id===t?q(R({},s),{documents:[...s.documents,a]}):s);l(n.id,i)},V=(t,a,i)=>N(null,null,function*(){if(r(n.id,t,a),w(!1),i){I(!0);try{const s=yield ne(t,n.startDate);s.length>0?(b(n.id,s),alert("تم إنشاء وتحديث الجدول الزمني بنجاح بناءً على المقايسة.")):alert("تم تحليل المقايسة ولكن لم يتم العثور على مهام لإنشاء جدول زمني.")}catch(s){alert(`فشل إنشاء الجدول الزمني: ${s.message}`)}finally{I(!1)}}}),W=t=>N(null,null,function*(){if(c){F(!0);try{const{title:a,content:i}=yield le(n,t,c.name),s={id:`doc-ai-${Date.now()}`,title:a,content:i,lastUpdated:new Date().toISOString()};U(c.id,s),v(!1)}catch(a){alert(`Failed to generate draft: ${a.message}`)}finally{F(!1)}}}),H=()=>{window.print()},K=()=>{if(!c){alert("Please select a category to export.");return}const t=c.documents.map(s=>{var g;return{العنوان:s.title,"آخر تحديث":new Date(s.lastUpdated).toLocaleDateString(),"اسم الملف":((g=s.file)==null?void 0:g.name)||"N/A"}}),a=XLSX.utils.json_to_sheet(t),i=XLSX.utils.book_new();XLSX.utils.book_append_sheet(i,a,c.name.substring(0,31)),XLSX.writeFile(i,`docs_${c.name.replace(/\s/g,"_")}.xlsx`)};return e.jsxs("div",{className:"printable-area",children:[e.jsxs("header",{className:"flex justify-between items-center mb-8 flex-wrap gap-4 no-print",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"المستندات الهندسية"}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:["إدارة المستندات الفنية والعقود لمشروع: ",e.jsx("span",{className:"font-semibold",children:n.name})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:K,disabled:!c||!c.documents.length,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-slate-400",children:[e.jsx(oe,{size:18}),e.jsx("span",{children:"تصدير Excel"})]}),e.jsxs("button",{onClick:H,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(de,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]}),e.jsxs("button",{onClick:()=>v(!0),disabled:!o||j,className:"flex items-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-slate-400",children:[e.jsx(X,{size:18}),e.jsx("span",{children:"إنشاء مسودة (AI)"})]}),e.jsxs("button",{onClick:()=>{var t;return(t=f.current)==null?void 0:t.click()},disabled:!o||j||k,className:"flex items-center gap-2 bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700 transition-colors disabled:bg-slate-400",children:[j?e.jsx(ce,{size:18,className:"animate-spin"}):e.jsx(me,{size:18}),e.jsx("span",{children:j?"جاري الرفع...":"رفع مجلد"})]}),e.jsxs("button",{onClick:()=>{var t;return(t=p.current)==null?void 0:t.click()},disabled:!o||j||k,className:"flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-slate-400",children:[k?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(ge,{size:18}),e.jsx("span",{children:k?"جاري إنشاء الجدول...":"رفع مستند"})]}),e.jsx("input",{type:"file",ref:p,onChange:Q,className:"hidden"}),e.jsx("input",{type:"file",ref:f,onChange:J,className:"hidden",webkitdirectory:"",directory:"",multiple:!0})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-8",children:[e.jsxs("div",{className:"md:col-span-1 no-print",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"الأقسام"}),e.jsx("nav",{className:"space-y-2",children:m.map(t=>e.jsxs("button",{onClick:()=>d(t.id),className:`w-full text-right flex items-center gap-3 p-3 rounded-lg transition-all text-sm font-medium ${o===t.id?"bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-300":"hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 dark:text-gray-400"}`,children:[e.jsx($,{size:20}),e.jsxs("span",{children:[t.name," (",t.documents.length,")"]})]},t.id))})]}),e.jsx("div",{className:"md:col-span-3",children:c?e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 border border-gray-200 dark:border-gray-800 p-6 rounded-xl shadow-sm",children:[e.jsx("h2",{className:"text-2xl font-bold mb-4",children:c.name}),e.jsxs("div",{className:"space-y-3",children:[c.documents.map(t=>e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-800 p-4 rounded-lg flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xe,{size:24,className:"text-indigo-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.title}),e.jsxs("p",{className:"text-xs text-slate-500",children:["آخر تحديث: ",new Date(t.lastUpdated).toLocaleDateString()]})]})]}),e.jsx("div",{className:"flex items-center gap-2 no-print",children:t.file&&e.jsx("a",{href:t.file.url,download:t.file.name,className:"text-indigo-600 hover:underline text-sm",children:"تحميل"})})]},t.id)),c.documents.length===0&&e.jsx("p",{className:"text-center text-slate-500 py-8",children:"لا توجد مستندات في هذا القسم."})]})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center text-gray-500 bg-white dark:bg-gray-900/50 border border-gray-200 dark:border-gray-800 p-6 rounded-xl shadow-sm",children:[e.jsx($,{size:48,className:"mb-4"}),e.jsx("h3",{className:"text-xl font-semibold",children:"الرجاء اختيار قسم"}),e.jsx("p",{children:"اختر قسمًا من القائمة لعرض مستنداته."})]})})]}),e.jsx(re,{isOpen:y,onClose:()=>w(!1),onConfirm:V,financialItems:M,fileName:G,isLoading:_}),c&&e.jsx(pe,{isOpen:A,onClose:()=>v(!1),onSubmit:W,categoryName:c.name,isLoading:T})]})};export{ve as EngineeringDocsManager};
