var V=Object.defineProperty,W=Object.defineProperties;var Y=Object.getOwnPropertyDescriptors;var X=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var $=(r,l,t)=>l in r?V(r,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[l]=t,P=(r,l)=>{for(var t in l||(l={}))Z.call(l,t)&&$(r,t,l[t]);if(X)for(var t of X(l))ee.call(l,t)&&$(r,t,l[t]);return r},T=(r,l)=>W(r,Y(l));var S=(r,l,t)=>new Promise((n,i)=>{var d=c=>{try{u(t.next(c))}catch(g){i(g)}},h=c=>{try{u(t.throw(c))}catch(g){i(g)}},u=c=>c.done?n(c.value):Promise.resolve(c.value).then(d,h);u((t=t.apply(r,l)).next())});import{r as o,j as e}from"./react-vendor-ITqvX6Xp.js";import{f as se,h as te,i as ae,j as re,k as le,l as ne}from"./index-Bo7nH3UG.js";import{X as oe,a1 as de,N as ie,O as ce,a2 as xe,Q as me,o as he,I as pe,a3 as be,a4 as ue,a5 as ge}from"./icons-lib-Bt_-gcnY.js";import{O as je}from"./OrderModal-D8kFHzM6.js";import{k as fe,v as Ne}from"./utils-lib-C_gzCXPI.js";import"./vendor-8CkhJSGZ.js";import"./vendor-large-gsDFeA65.js";import"./genai-lib-pAIF5Ws4.js";const O=({title:r,items:l,color:t})=>{const n=l.reduce((i,d)=>i+d.estimatedTotal,0);return l.length===0?null:e.jsxs("tbody",{className:"border-t-2 border-slate-300 dark:border-slate-600",children:[e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:`p-2 font-bold text-lg ${t}`,children:r})}),l.map((i,d)=>e.jsxs("tr",{className:"border-b border-slate-200 dark:border-slate-700 last:border-b-0",children:[e.jsx("td",{className:"p-2","data-label":"الوصف",children:i.description}),e.jsx("td",{className:"p-2 font-mono text-center","data-label":"الكمية",children:i.quantity.toLocaleString("ar-SA")}),e.jsx("td",{className:"p-2 text-center","data-label":"الوحدة",children:i.unit}),e.jsx("td",{className:"p-2 font-mono","data-label":"سعر الوحدة",children:i.estimatedUnitPrice.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})}),e.jsx("td",{className:"p-2 font-mono","data-label":"الإجمالي",children:i.estimatedTotal.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})})]},d)),e.jsxs("tr",{children:[e.jsxs("td",{colSpan:4,className:"p-2 text-left font-semibold",children:["إجمالي ",r]}),e.jsx("td",{className:"p-2 font-mono font-semibold",children:n.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})})]})]})},ye=({isOpen:r,onClose:l,item:t,result:n,isLoading:i,error:d})=>{if(!r)return null;const{directCostTotal:h,overheadsAmount:u,profitAmount:c,finalTotal:g,groupedItems:f}=o.useMemo(()=>{if(!n||!n.items)return{directCostTotal:0,overheadsAmount:0,profitAmount:0,finalTotal:0,groupedItems:{}};const j=n.items.reduce((p,x)=>p+x.estimatedTotal,0),N=j*(n.overheadsPercentage/100),v=j+N,y=v*(n.profitPercentage/100),w=v+y,k=n.items.reduce((p,x)=>((p[x.costType]=p[x.costType]||[]).push(x),p),{});return{directCostTotal:j,overheadsAmount:N,profitAmount:y,finalTotal:w,groupedItems:k}},[n]);return e.jsx("div",{className:"modal",style:{display:"block"},onClick:l,children:e.jsxs("div",{className:"modal-content p-8 max-w-4xl dark:bg-gray-800",onClick:j=>j.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"تحليل تفصيلي لتكلفة الوحدة"}),e.jsx("button",{onClick:l,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(oe,{size:24})})]}),e.jsx("p",{className:"mb-6 text-slate-600 dark:text-slate-400 font-semibold",children:t==null?void 0:t.item}),i&&e.jsxs("div",{className:"text-center p-12",children:[e.jsx(de,{className:"animate-spin h-12 w-12 text-indigo-500 mx-auto mb-4"}),e.jsx("p",{children:"جاري تحليل التكلفة..."})]}),d&&e.jsxs("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded",role:"alert",children:[e.jsx("p",{className:"font-bold",children:"خطأ في التحليل"}),e.jsx("p",{children:d})]}),n&&e.jsx("div",{className:"max-h-[60vh] overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right min-w-[700px] responsive-table",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-slate-900/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3",children:"الوصف"}),e.jsx("th",{className:"p-3 text-center",children:"الكمية"}),e.jsx("th",{className:"p-3 text-center",children:"الوحدة"}),e.jsx("th",{className:"p-3",children:"سعر الوحدة"}),e.jsx("th",{className:"p-3",children:"الإجمالي"})]})}),e.jsx(O,{title:"المواد",items:f.مواد||[],color:"text-green-600 dark:text-green-400"}),e.jsx(O,{title:"العمالة",items:f.عمالة||[],color:"text-sky-600 dark:text-sky-400"}),e.jsx(O,{title:"المعدات",items:f.معدات||[],color:"text-amber-600 dark:text-amber-400"}),e.jsxs("tfoot",{className:"bg-slate-100 dark:bg-slate-700 font-bold sticky bottom-0 text-sm",children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:4,className:"p-2 text-left",children:"إجمالي التكلفة المباشرة"}),e.jsx("td",{className:"p-2 font-mono",children:h.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})})]}),e.jsxs("tr",{children:[e.jsxs("td",{colSpan:4,className:"p-2 text-left",children:["التكاليف غير المباشرة (",n.overheadsPercentage,"%)"]}),e.jsx("td",{className:"p-2 font-mono",children:u.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})})]}),e.jsxs("tr",{children:[e.jsxs("td",{colSpan:4,className:"p-2 text-left",children:["هامش الربح (",n.profitPercentage,"%)"]}),e.jsx("td",{className:"p-2 font-mono",children:c.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})})]}),e.jsxs("tr",{className:"bg-slate-200 dark:bg-slate-600 text-base",children:[e.jsx("td",{colSpan:4,className:"p-3 text-left",children:"السعر الإجمالي للوحدة"}),e.jsx("td",{className:"p-3 font-mono",children:g.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})})]})]})]})})}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400 mt-4 italic",children:"* إخلاء مسؤولية: هذا التحليل تم إنشاؤه بواسطة الذكاء الاصطناعي وهو تقديري فقط. الأسعار والكميات قد لا تكون دقيقة ويجب التحقق منها بواسطة متخصص."}),e.jsx("div",{className:"flex justify-end mt-6",children:e.jsx("button",{type:"button",onClick:l,className:"px-4 py-2 rounded-lg text-slate-700 dark:text-slate-200 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500",children:"إغلاق"})})]})})},I=({label:r,value:l})=>e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-800 p-4 rounded-lg",children:[e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:r}),e.jsx("p",{className:"text-xl font-bold",children:l})]}),ve=({sentiment:r})=>{switch(r){case"Positive":return e.jsx(ge,{size:18,className:"text-green-500"});case"Negative":return e.jsx(ue,{size:18,className:"text-red-500"});case"Neutral":return e.jsx(be,{size:18,className:"text-gray-500"});default:return null}},Ie=({project:r,onUpdatePurchaseOrders:l})=>{const t=r.data.financials||[],[n,i]=o.useState(""),[d,h]=o.useState("financial"),[u,c]=o.useState(!1),[g,f]=o.useState(null),[j,N]=o.useState(null),[v,y]=o.useState(!1),[w,k]=o.useState(""),[p,x]=o.useState(""),[A,R]=o.useState(!1),[C,B]=o.useState([]),[_,z]=o.useState(!1),[E,Q]=o.useState(null),[L,M]=o.useState(null),q=o.useMemo(()=>t.filter(s=>s.item.toLowerCase().includes(n.toLowerCase())),[t,n]),F=o.useMemo(()=>t.reduce((s,a)=>s+a.total,0),[t]),G=s=>S(null,null,function*(){f(s),c(!0),y(!0),k(""),N(null);try{const a=yield se(s);N(a)}catch(a){k(a.message)}finally{y(!1)}}),D=s=>S(null,null,function*(){R(!0),x(""),B([]);try{if(s==="sentiment"){const a=yield ae(t);B(a)}else if(s==="price"){const a=yield re(t);x(a)}else{const a=s==="financial"?yield le(t):yield ne(t);x(a)}}catch(a){alert(`Analysis failed: ${a.message}`)}finally{R(!1)}}),H=s=>S(null,null,function*(){M(s.id);try{const a=yield te(s);Q(T(P({},a),{id:"",total:a.quantity*a.unitPrice})),z(!0)}catch(a){alert(`Failed to generate PO draft: ${a.message}`)}finally{M(null)}}),U=s=>{const a="id"in s&&s.id?s:T(P({},s),{id:Ne()}),m=[...r.data.purchaseOrders,a];l(r.id,m),alert("تم إنشاء أمر الشراء بنجاح وإضافته إلى قسم المشتريات.")},J=()=>{const s=t.map(b=>({ID:b.id,البند:b.item,الكمية:b.quantity,الوحدة:b.unit,"سعر الوحدة":b.unitPrice,الإجمالي:b.total})),a=XLSX.utils.json_to_sheet(s),m=XLSX.utils.book_new();XLSX.utils.book_append_sheet(m,a,"Financials"),XLSX.writeFile(m,`financials_${r.name.replace(/\s/g,"_")}.xlsx`)},K=()=>{window.print()};return e.jsxs("div",{children:[e.jsxs("header",{className:"flex justify-between items-center mb-8 flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"الإدارة المالية"}),e.jsxs("p",{className:"text-slate-500 mt-1",children:["نظرة عامة على مقايسة الكميات لمشروع: ",r.name]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:J,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(ie,{size:18}),e.jsx("span",{children:"تصدير Excel"})]}),e.jsxs("button",{onClick:K,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(ce,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8",children:[e.jsx(I,{label:"التكلفة الإجمالية للمشروع",value:`${F.toLocaleString("ar-SA")} SAR`}),e.jsx(I,{label:"عدد بنود المقايسة",value:String(t.length)}),e.jsx(I,{label:"متوسط تكلفة البند",value:`${(F/(t.length||1)).toLocaleString("ar-SA")} SAR`})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 bg-white dark:bg-slate-900/50 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 flex-wrap gap-2",children:[e.jsx("h3",{className:"text-xl font-semibold",children:"بنود المقايسة"}),e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"}),e.jsx("input",{type:"text",placeholder:"بحث في البنود...",value:n,onChange:s=>i(s.target.value),className:"w-full sm:w-64 bg-slate-100 dark:bg-slate-800 rounded-lg py-2 pr-10 pl-4 focus:outline-none focus:ring-2 focus:ring-sky-500"})]})]}),e.jsx("div",{className:"max-h-[60vh] overflow-y-auto",children:e.jsxs("table",{className:"w-full text-right responsive-table",children:[e.jsx("thead",{className:"sticky top-0 bg-slate-50 dark:bg-slate-900",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-3",children:"البند"}),e.jsx("th",{className:"p-3",children:"الكمية"}),e.jsx("th",{className:"p-3",children:"الوحدة"}),e.jsx("th",{className:"p-3",children:"سعر الوحدة"}),e.jsx("th",{className:"p-3",children:"الإجمالي"}),e.jsx("th",{className:"p-3"})]})}),e.jsx("tbody",{children:q.map(s=>{const a=C.find(b=>b.itemId===s.id),m=(a==null?void 0:a.sentiment)==="Negative";return e.jsxs("tr",{className:`border-b border-slate-200 dark:border-slate-800 last:border-b-0 transition-colors ${m?"bg-red-50 dark:bg-red-900/20":""}`,children:[e.jsx("td",{className:"p-3 font-medium","data-label":"البند",children:e.jsxs("div",{className:"flex items-center gap-2",children:[m&&e.jsx("span",{title:a.justification,children:e.jsx(me,{size:16,className:"text-red-500 shrink-0"})}),e.jsx("span",{children:s.item})]})}),e.jsx("td",{className:"p-3","data-label":"الكمية",children:s.quantity}),e.jsx("td",{className:"p-3","data-label":"الوحدة",children:s.unit}),e.jsx("td",{className:"p-3 font-mono","data-label":"سعر الوحدة",children:s.unitPrice.toLocaleString("ar-SA")}),e.jsx("td",{className:"p-3 font-mono font-semibold","data-label":"الإجمالي",children:s.total.toLocaleString("ar-SA")}),e.jsx("td",{className:"p-3","data-label":"إجراء",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>G(s),className:"text-sky-600 hover:underline text-sm font-semibold",children:"تحليل"}),e.jsxs("button",{onClick:()=>H(s),disabled:L===s.id,className:"text-indigo-600 hover:underline text-sm font-semibold disabled:text-gray-400 flex items-center gap-1",children:[L===s.id?"...":e.jsx(he,{size:14}),e.jsx("span",{children:L===s.id?"":"أمر شراء"})]})]})})]},s.id)})})]})})]}),e.jsxs("div",{className:"bg-white dark:bg-slate-900/50 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-800",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"تحليل المقايسة بالذكاء الاصطناعي"}),e.jsx("div",{className:"border-b border-gray-200 dark:border-gray-700 mb-4",children:e.jsxs("nav",{className:"-mb-px flex space-x-2 rtl:space-x-reverse overflow-x-auto","aria-label":"Tabs",children:[e.jsx("button",{onClick:()=>h("financial"),className:`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${d==="financial"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:border-gray-300"}`,children:"تحليل مالي"}),e.jsx("button",{onClick:()=>h("code"),className:`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${d==="code"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:border-gray-300"}`,children:"توافق الكود"}),e.jsx("button",{onClick:()=>h("sentiment"),className:`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${d==="sentiment"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:border-gray-300"}`,children:"تحليل المشاعر"}),e.jsx("button",{onClick:()=>h("price"),className:`whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm ${d==="price"?"border-indigo-500 text-indigo-600":"border-transparent text-gray-500 hover:border-gray-300"}`,children:"تحليل الأسعار"})]})}),e.jsxs("button",{onClick:()=>D(d),disabled:A||t.length===0,className:"w-full flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400",children:[e.jsx(pe,{size:18}),e.jsx("span",{children:A?"...جاري التحليل":"تشغيل التحليل"})]}),e.jsx("div",{className:"mt-4 p-4 bg-slate-50 dark:bg-slate-800 rounded-lg min-h-[200px] max-h-[55vh] overflow-y-auto",children:A?e.jsx("p",{children:"...جاري التحليل"}):d==="sentiment"&&C.length>0?e.jsx("table",{className:"w-full text-sm",children:e.jsx("tbody",{children:C.map(s=>{const a=t.find(m=>m.id===s.itemId);return e.jsxs("tr",{className:"border-b border-slate-200 dark:border-slate-700 last:border-b-0",children:[e.jsx("td",{className:"p-2 w-10 text-center",children:e.jsx(ve,{sentiment:s.sentiment})}),e.jsxs("td",{className:"p-2",children:[e.jsx("p",{className:"font-semibold",children:a==null?void 0:a.item}),e.jsx("p",{className:"text-xs text-slate-500",children:s.justification})]})]},s.itemId)})})}):p?e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:fe.parse(p)}}):e.jsx("p",{className:"text-slate-500 text-center pt-8",children:"ستظهر نتائج التحليل هنا."})})]})]}),e.jsx(ye,{isOpen:u,onClose:()=>c(!1),item:g,result:j,isLoading:v,error:w}),e.jsx(je,{isOpen:_,onClose:()=>z(!1),onSave:U,order:E})]})};export{Ie as FinancialManager};
