var V=Object.defineProperty,Z=Object.defineProperties;var ee=Object.getOwnPropertyDescriptors;var P=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var A=(t,i,o)=>i in t?V(t,i,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[i]=o,H=(t,i)=>{for(var o in i||(i={}))re.call(i,o)&&A(t,o,i[o]);if(P)for(var o of P(i))te.call(i,o)&&A(t,o,i[o]);return t},W=(t,i)=>Z(t,ee(i));import{f as E,j as e,r as y}from"./react-vendor-ITqvX6Xp.js";import{a8 as se,a9 as ne,ao as ae,aQ as ie,aI as oe,R as de}from"./icons-lib-Bt_-gcnY.js";const le=({position:t,onClose:i,onEdit:o,onDelete:h})=>{const x=E.useRef(null);E.useEffect(()=>{const b=$=>{x.current&&!x.current.contains($.target)&&i()};return setTimeout(()=>document.addEventListener("mousedown",b),0),()=>{document.removeEventListener("mousedown",b)}},[i]);const N=b=>{b(),i()};return e.jsx("div",{ref:x,style:{top:t.top,right:t.right},className:"absolute z-20 w-36 bg-white dark:bg-gray-800 rounded-md shadow-lg border border-gray-200 dark:border-gray-700",children:e.jsxs("ul",{className:"p-1 text-sm text-gray-700 dark:text-gray-200",children:[e.jsx("li",{children:e.jsxs("button",{onClick:()=>N(o),className:"flex items-center gap-2 w-full text-right px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md",children:[e.jsx(se,{size:16}),e.jsx("span",{children:"تعديل"})]})}),e.jsx("li",{children:e.jsxs("button",{onClick:()=>N(h),className:"flex items-center gap-2 w-full text-right px-3 py-2 text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md",children:[e.jsx(ne,{size:16}),e.jsx("span",{children:"حذف"})]})})]})})},d=35,D=(t,i)=>{const o=new Date(t.getFullYear(),t.getMonth(),t.getDate()),h=new Date(i.getFullYear(),i.getMonth(),i.getDate()),x=o.getTime()-h.getTime();return Math.round(x/(1e3*60*60*24))},ce=t=>{switch(t){case"Done":return e.jsx(de,{size:16,className:"text-green-500"});case"In Progress":return e.jsx(oe,{size:16,className:"text-sky-500 animate-spin [animation-duration:3s]"});case"To Do":default:return e.jsx(ie,{size:16,className:"text-slate-400"})}},ge=t=>{switch(t){case"High":return"border-red-500";case"Medium":return"border-yellow-500";case"Low":default:return"border-slate-300"}},ue=t=>{switch(t){case"Done":return{bg:"bg-green-100 dark:bg-green-500/10 group-hover:bg-green-200 dark:group-hover:bg-green-500/20",fill:"bg-green-500"};case"In Progress":return{bg:"bg-sky-100 dark:bg-sky-500/10 group-hover:bg-sky-200 dark:group-hover:bg-sky-500/20",fill:"bg-sky-500"};case"To Do":default:return{bg:"bg-slate-200 dark:bg-slate-700/30 group-hover:bg-slate-300 dark:group-hover:bg-slate-700/50",fill:"bg-slate-500 dark:bg-slate-400"}}},he=t=>{switch(t){case"High":return"border-r-4 border-red-500";case"Medium":return"border-r-4 border-yellow-500";case"Low":default:return""}},be=E.memo(({tasks:t,members:i,projectStartDate:o,onEditTask:h,onDeleteTask:x,cpmResult:N})=>{const[b,$]=y.useState(null),[Y,F]=y.useState({top:0,right:0}),[p,B]=y.useState(null),T=y.useRef(null),M=y.useRef(null),S=y.useRef(null),C=y.useRef(null),{processedTasks:m,projectDuration:I,startDate:G,months:_,days:L}=y.useMemo(()=>{if(t.length===0)return{processedTasks:[],projectDuration:30,startDate:new Date(o),months:[],days:[]};const r=t.filter(n=>n.start&&n.end&&!isNaN(new Date(n.start).getTime())&&!isNaN(new Date(n.end).getTime())),a=r.flatMap(n=>{const f=[new Date(n.start).getTime(),new Date(n.end).getTime()];return n.originalStart&&f.push(new Date(n.originalStart).getTime()),n.originalEnd&&f.push(new Date(n.originalEnd).getTime()),f});a.length===0&&a.push(new Date(o).getTime());const s=new Date(Math.min(...a));s.setDate(s.getDate()-7);const l=new Date(Math.max(...a));l.setDate(l.getDate()+7);const u=D(l,s)+1,c=r.map(n=>{const f=new Date(n.start),z=new Date(n.end),q=D(f,s),J=D(z,f)+1,K=n.originalStart?D(new Date(n.originalStart),s):void 0,U=n.originalStart&&n.originalEnd?D(new Date(n.originalEnd),new Date(n.originalStart))+1:void 0;return W(H({},n),{startDay:q,duration:J,originalStartDay:K,originalDuration:U})}).sort((n,f)=>new Date(n.start).getTime()-new Date(f.start).getTime()),w=[],v=[];let g=new Date(s),j=-1;for(;g<=l;)g.getMonth()!==j&&(w.push({name:g.toLocaleString("ar-SA",{month:"long",year:"numeric"}),startDay:D(g,s)}),j=g.getMonth()),v.push({date:new Date(g),dayNumber:g.getDate()}),g.setDate(g.getDate()+1);return{processedTasks:c,projectDuration:u,startDate:s,months:w,days:v}},[t,o]),{highlightedTaskIds:k,dependencyLinks:O}=y.useMemo(()=>{if(!p)return{highlightedTaskIds:new Set,dependencyLinks:[]};const r=new Set([p]),a=[],s=m.find(c=>c.id===p);if(!s)return{highlightedTaskIds:k,dependencyLinks:[]};const u=m.findIndex(c=>c.id===p)*48+24;return s.dependencies.forEach(c=>{const w=m.find(v=>v.id===c);if(w){r.add(c);const g=m.findIndex(z=>z.id===c)*48+24,j=(w.startDay+w.duration)*d,n=s.startDay*d,f=`M ${j} ${g} C ${j+40} ${g}, ${n-40} ${u}, ${n} ${u}`;a.push({key:`${c}-${p}`,d:f})}}),m.forEach((c,w)=>{if(c.dependencies.includes(p)){r.add(c.id);const v=w*48+24,g=(s.startDay+s.duration)*d,j=c.startDay*d,n=`M ${g} ${u} C ${g+40} ${u}, ${j-40} ${v}, ${j} ${v}`;a.push({key:`${p}-${c.id}`,d:n})}}),{highlightedTaskIds:r,dependencyLinks:a}},[p,m]),Q=(r,a)=>{if(r.stopPropagation(),!h||!x)return;const l=r.currentTarget.getBoundingClientRect();if(T.current){const u=T.current.getBoundingClientRect();F({top:l.bottom-u.top+8,right:u.right-l.right-144/2+l.width/2}),$(a===b?null:a)}},X=r=>{const a=r.currentTarget;S.current&&C.current&&(S.current.scrollTop=a.scrollTop,C.current.scrollTop=a.scrollTop),M.current&&(M.current.scrollLeft=a.scrollLeft)};if(t.length===0)return e.jsx("div",{className:"text-center p-8 bg-white dark:bg-slate-800 rounded-lg",children:"لا توجد مهام لعرضها."});const R=D(new Date,G);return e.jsxs("div",{ref:T,className:"gantt-container bg-white dark:bg-gray-900/50 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800 w-full overflow-hidden relative",children:[e.jsxs("div",{className:"flex",children:[e.jsxs("div",{className:"w-[500px] border-l border-gray-200 dark:border-gray-800 flex flex-col shrink-0",children:[e.jsxs("div",{className:"h-20 flex items-center p-3 border-b border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900",children:[e.jsx("div",{className:"flex-grow font-semibold text-sm",children:"المهمة"}),e.jsx("div",{className:"w-20 font-semibold text-sm text-center",children:"المسؤول"}),e.jsx("div",{className:"w-20 font-semibold text-sm text-center",children:"الحالة"}),e.jsx("div",{className:"w-10"})]}),e.jsx("div",{ref:S,className:"overflow-y-hidden",style:{height:`${m.length*48}px`},children:m.map(r=>{const a=i.filter(s=>{var l;return(l=r.assignees)==null?void 0:l.includes(s.id)});return e.jsxs("div",{className:`flex items-center p-3 h-12 border-b border-gray-100 dark:border-gray-800 transition-colors ${k.has(r.id)?"bg-indigo-50 dark:bg-indigo-900/30":""}`,children:[e.jsxs("div",{className:`flex-grow truncate text-sm flex items-center gap-2 border-r-4 pr-2 ${ge(r.priority)}`,children:[e.jsx("span",{className:"font-mono text-xs text-slate-400",children:r.id}),e.jsx("span",{className:"truncate",children:r.name})]}),e.jsx("div",{className:"w-20 flex justify-center items-center -space-x-2",children:a.slice(0,3).map(s=>e.jsx("div",{title:s.name,className:"w-6 h-6 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-xs font-bold text-indigo-600 border-2 border-white dark:border-gray-900",children:s.name.charAt(0)},s.id))}),e.jsx("div",{className:"w-20 flex justify-center",children:ce(r.status)}),e.jsx("div",{className:"w-10 flex justify-center",children:h&&x&&e.jsx("button",{onClick:s=>Q(s,r.id),className:"p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700",children:e.jsx(ae,{size:18})})})]},r.id)})})]}),e.jsxs("div",{className:"flex-grow overflow-x-auto",onScroll:X,children:[e.jsxs("div",{ref:M,className:"h-20 border-b border-gray-200 dark:border-gray-800 sticky top-0 bg-gray-50 dark:bg-gray-900 z-10",style:{width:`${I*d}px`},children:[e.jsx("div",{className:"h-10 flex border-b border-gray-200 dark:border-gray-800",children:_.map((r,a)=>e.jsx("div",{className:"flex items-center justify-center font-semibold text-sm border-l border-gray-200 dark:border-gray-800",style:{width:`${L.filter(s=>s.date.toLocaleString("ar-SA",{month:"long",year:"numeric"})===r.name).length*d}px`},children:r.name},a))}),e.jsx("div",{className:"h-10 flex",children:L.map((r,a)=>{const s=r.date.getDay()===4||r.date.getDay()===5;return e.jsx("div",{className:`w-[${d}px] h-full flex items-center justify-center text-xs border-l border-gray-200 dark:border-gray-800 ${s?"bg-gray-100 dark:bg-gray-800/50":""}`,children:r.dayNumber},a)})})]}),e.jsxs("div",{ref:C,className:"relative",style:{width:`${I*d}px`,height:`${m.length*48}px`},children:[L.map((r,a)=>e.jsx("div",{className:"absolute top-0 h-full border-l border-gray-100 dark:border-gray-800",style:{left:`${a*d}px`,width:`${d}px`}},a)),R>=0&&R<I&&e.jsx("div",{className:"absolute top-0 h-full w-0.5 bg-red-500 z-10",style:{left:`${R*d+d/2}px`},children:e.jsx("div",{className:"absolute -top-4 -translate-x-1/2 text-xs text-red-500 font-bold",children:"اليوم"})}),e.jsxs("svg",{width:"100%",height:"100%",className:"absolute top-0 left-0 pointer-events-none",children:[O.map(r=>e.jsx("path",{d:r.d,stroke:"#4f46e5",strokeWidth:"1.5",fill:"none",markerEnd:"url(#arrow)"},r.key)),e.jsx("defs",{children:e.jsx("marker",{id:"arrow",viewBox:"0 0 10 10",refX:"8",refY:"5",markerWidth:"6",markerHeight:"6",orient:"auto-start-reverse",children:e.jsx("path",{d:"M 0 0 L 10 5 L 0 10 z",fill:"#4f46e5"})})})]}),m.map((r,a)=>{const s=N==null?void 0:N.criticalActivityIds.includes(r.id),l=ue(r.status),u=r.originalStartDay!==void 0&&r.originalDuration!==void 0;return e.jsxs("div",{className:`absolute h-12 flex items-center group cursor-pointer ${k.size>0&&!k.has(r.id)?"opacity-30":""}`,style:{top:`${a*48}px`},onMouseEnter:()=>B(r.id),onMouseLeave:()=>B(null),onClick:()=>h&&h(r),children:[u&&e.jsx("div",{className:"absolute h-4 bg-gray-300 dark:bg-gray-600 rounded-md opacity-70",style:{left:`${r.originalStartDay*d}px`,width:`${r.originalDuration*d}px`}}),e.jsxs("div",{className:`relative h-8 rounded-md flex items-center justify-between px-2 text-xs font-medium text-white ${l.bg} ${he(r.priority)} ${s?"ring-2 ring-red-500":""}`,style:{left:`${r.startDay*d}px`,width:`${r.duration*d}px`},children:[e.jsx("div",{className:`absolute top-0 left-0 h-full rounded-md ${l.fill}`,style:{width:`${r.progress}%`}}),e.jsx("span",{className:"relative truncate",children:r.name})]})]},r.id)})]})]})]}),b&&h&&x&&e.jsx(le,{position:Y,onClose:()=>$(null),onEdit:()=>h(t.find(r=>r.id===b)),onDelete:()=>x(b)})]})});export{be as G};
