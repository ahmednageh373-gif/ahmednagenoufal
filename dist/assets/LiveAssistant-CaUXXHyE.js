var U=Object.defineProperty,Y=Object.defineProperties;var G=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var q=Object.prototype.hasOwnProperty,H=Object.prototype.propertyIsEnumerable;var E=(n,t,s)=>t in n?U(n,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[t]=s,k=(n,t)=>{for(var s in t||(t={}))q.call(t,s)&&E(n,s,t[s]);if(O)for(var s of O(t))H.call(t,s)&&E(n,s,t[s]);return n},v=(n,t)=>Y(n,G(t));var I=(n,t,s)=>new Promise((r,c)=>{var u=m=>{try{x(s.next(m))}catch(a){c(a)}},b=m=>{try{x(s.throw(m))}catch(a){c(a)}},x=m=>m.done?r(m.value):Promise.resolve(m.value).then(u,b);x((s=s.apply(n,t)).next())});import{r as S,j as e}from"./react-vendor-D4cZjflF.js";import{G as K,M as W}from"./genai-lib-BGDjQqRJ.js";import{X,aX as _,aY as Q,M as B,a1 as Z,aZ as J,a_ as V}from"./icons-lib-mPL1tuN6.js";import"./vendor-DhnXlGBj.js";const ee=[{key:"projectManager",label:"مدير مشروع خبير",description:"لغة رسمية، إجابات مفصلة، وتركيز على المنهجيات."},{key:"technicalAssistant",label:"مساعد تقني",description:"إجابات مباشرة، دقيقة، وتركز على البيانات والحقائق."},{key:"educationalConsultant",label:"مستشار تعليمي",description:"أسلوب ودي، شروحات واضحة للمفاهيم المعقدة."}],te=[{key:"formal",label:"رسمي"},{key:"friendly",label:"ودي"}],se=[{key:"concise",label:"مختصر"},{key:"detailed",label:"تفصيلي"}],ne=({isOpen:n,onClose:t,currentSettings:s,onSave:r})=>{const[c,u]=S.useState(k({persona:"projectManager",tone:"formal",style:"concise"},s));S.useEffect(()=>{u(k({persona:"projectManager",tone:"formal",style:"concise"},s))},[s,n]);const b=a=>{switch(a){case"projectManager":u({persona:a,tone:"formal",style:"detailed"});break;case"technicalAssistant":u({persona:a,tone:"formal",style:"concise"});break;case"educationalConsultant":u({persona:a,tone:"friendly",style:"detailed"});break}},x=a=>{a.preventDefault(),r(c),t()};if(!n)return null;const m=(a,g,f,p)=>e.jsxs("fieldset",{className:"mb-6",children:[e.jsx("legend",{className:"text-lg font-semibold text-slate-800 dark:text-slate-200 mb-3",children:p}),e.jsx("div",{className:"space-y-3",children:a.map(({key:y,label:P,description:T})=>e.jsxs("label",{className:`flex items-start p-4 rounded-lg border-2 cursor-pointer transition-colors ${g===y?"bg-indigo-50 border-indigo-500 dark:bg-indigo-900/50":"bg-gray-50 border-gray-200 dark:bg-gray-700 dark:border-gray-600 hover:border-indigo-300"}`,children:[e.jsx("input",{type:"radio",name:p,value:y,checked:g===y,onChange:()=>f(y),className:"h-4 w-4 mt-1 border-gray-300 text-indigo-600 focus:ring-indigo-500"}),e.jsxs("span",{className:"mr-3 text-sm",children:[e.jsx("span",{className:"font-medium text-slate-900 dark:text-white block",children:P}),T&&e.jsx("span",{className:"text-slate-500 dark:text-slate-400",children:T})]})]},y))})]});return e.jsx("div",{className:"modal",style:{display:"block"},onClick:t,children:e.jsxs("div",{className:"modal-content p-8 max-w-2xl dark:bg-gray-800",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6 shrink-0",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"تخصيص شخصية المساعد"}),e.jsx("button",{onClick:t,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(X,{size:24})})]}),e.jsxs("form",{onSubmit:x,className:"flex-grow overflow-y-auto pr-2",children:[m(ee,c.persona,b,"اختر شخصية المساعد"),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("fieldset",{children:[e.jsx("legend",{className:"text-base font-semibold text-slate-800 dark:text-slate-200 mb-2",children:"النبرة"}),e.jsx("div",{className:"flex items-center gap-2 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg",children:te.map(({key:a,label:g})=>e.jsx("button",{type:"button",onClick:()=>u(f=>v(k({},f),{tone:a})),className:`w-full py-2 text-sm rounded-md ${c.tone===a?"bg-white dark:bg-gray-900 shadow-sm":""}`,children:g},a))})]}),e.jsxs("fieldset",{children:[e.jsx("legend",{className:"text-base font-semibold text-slate-800 dark:text-slate-200 mb-2",children:"أسلوب اللغة"}),e.jsx("div",{className:"flex items-center gap-2 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg",children:se.map(({key:a,label:g})=>e.jsx("button",{type:"button",onClick:()=>u(f=>v(k({},f),{style:a})),className:`w-full py-2 text-sm rounded-md ${c.style===a?"bg-white dark:bg-gray-900 shadow-sm":""}`,children:g},a))})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6 shrink-0 border-t border-gray-200 dark:border-gray-700 pt-4",children:[e.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 rounded-lg text-slate-700 dark:text-slate-200 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold",children:"إلغاء"}),e.jsx("button",{type:"submit",onClick:x,className:"px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 font-semibold",children:"حفظ الإعدادات"})]})]})})};function ae(n){let t="";const s=n.byteLength;for(let r=0;r<s;r++)t+=String.fromCharCode(n[r]);return btoa(t)}function re(n){const t=atob(n),s=t.length,r=new Uint8Array(s);for(let c=0;c<s;c++)r[c]=t.charCodeAt(c);return r}function oe(n,t,s,r){return I(this,null,function*(){const c=new Int16Array(n.buffer),u=c.length/r,b=t.createBuffer(r,u,s);for(let x=0;x<r;x++){const m=b.getChannelData(x);for(let a=0;a<u;a++)m[a]=c[a*r+x]/32768}return b})}function ie(n){const t=n.length,s=new Int16Array(t);for(let r=0;r<t;r++)s[r]=n[r]*32768;return{data:ae(new Uint8Array(s.buffer)),mimeType:"audio/pcm;rate=16000"}}const ce=n=>{const t=n.data.assistantSettings,s=(t==null?void 0:t.persona)||"projectManager",r=(t==null?void 0:t.tone)||"formal",c=(t==null?void 0:t.style)||"concise",u={projectManager:"an expert project manager",technicalAssistant:"a technical assistant focused on facts and data",educationalConsultant:"an educational consultant who explains concepts clearly"},b={formal:"formal and professional",friendly:"friendly and approachable"},x={concise:"concise and to the point",detailed:"detailed and comprehensive"},m=n.data.financials||[];let a="";if(m.length>0){const g=m.reduce((p,y)=>p+y.total,0),f=[...m].sort((p,y)=>y.total-p.total).slice(0,5).map(p=>`- ${p.item}: ${p.total.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})}`).join(`
`);a=`

Here is a summary of the project's Bill of Quantities for context:
- Total Estimated Cost: ${g.toLocaleString("ar-SA",{style:"currency",currency:"SAR"})}
- Total Number of Items: ${m.length}
- Top 5 Cost Drivers:
${f}

Use this financial data to answer questions about budget, costs, and scope.`}return`You are a helpful project management assistant for AN.AI Ahmed Nageh. You are assisting with the project named "${n.name}", which is about "${n.description}".
Your persona is: ${u[s]}.
Your tone should be: ${b[r]}.
Your response style should be: ${x[c]}.
${a}
Directly answer questions related to project management. All your responses must be in Arabic.`},pe=({project:n,onUpdateSettings:t})=>{const[s,r]=S.useState("idle"),[c,u]=S.useState([]),[b,x]=S.useState(null),[m,a]=S.useState(!1),g=S.useRef(null),f=S.useRef({inputAudioContext:null,outputAudioContext:null,mediaStream:null,mediaStreamSource:null,scriptProcessor:null,nextStartTime:0,sources:new Set}),p=S.useCallback(()=>{var w,M,o,C,N,A;(w=g.current)==null||w.then(j=>j.close()),g.current=null;const i=f.current;(M=i.mediaStream)==null||M.getTracks().forEach(j=>j.stop()),(o=i.scriptProcessor)==null||o.disconnect(),(C=i.mediaStreamSource)==null||C.disconnect(),(N=i.inputAudioContext)==null||N.close(),(A=i.outputAudioContext)==null||A.close(),i.sources.forEach(j=>j.stop()),f.current={inputAudioContext:null,outputAudioContext:null,mediaStream:null,mediaStreamSource:null,scriptProcessor:null,nextStartTime:0,sources:new Set}},[]),y=()=>I(null,null,function*(){r("connecting"),x(null),u([]);try{const i=yield navigator.mediaDevices.getUserMedia({audio:!0});f.current.mediaStream=i;const w=new K({apiKey:"AIzaSyAK_UVp3OsRKnakSBiTOSp9mzkPioy7O3A"}),M=ce(n);g.current=w.live.connect({model:"gemini-2.5-flash-native-audio-preview-09-2025",config:{responseModalities:[W.AUDIO],inputAudioTranscription:{},outputAudioTranscription:{},systemInstruction:M},callbacks:{onopen:()=>{const o=f.current;o.inputAudioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3}),o.outputAudioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}),o.mediaStreamSource=o.inputAudioContext.createMediaStreamSource(i),o.scriptProcessor=o.inputAudioContext.createScriptProcessor(4096,1,1),o.scriptProcessor.onaudioprocess=C=>{var j;const N=C.inputBuffer.getChannelData(0),A=ie(N);(j=g.current)==null||j.then($=>{$.sendRealtimeInput({media:A})})},o.mediaStreamSource.connect(o.scriptProcessor),o.scriptProcessor.connect(o.inputAudioContext.destination),r("connected")},onmessage:o=>I(null,null,function*(){var N,A,j,$,D,F,z;if((N=o.serverContent)!=null&&N.inputTranscription){const d=o.serverContent.inputTranscription.text;u(h=>{const l=h[h.length-1];if((l==null?void 0:l.type)==="user"&&!l.isFinal){const R=v(k({},l),{text:l.text+d});return[...h.slice(0,-1),R]}return[...h,{type:"user",text:d,isFinal:!1}]})}if((A=o.serverContent)!=null&&A.outputTranscription){const d=o.serverContent.outputTranscription.text;u(h=>{const l=h[h.length-1];if((l==null?void 0:l.type)==="model"&&!l.isFinal){const R=v(k({},l),{text:l.text+d});return[...h.slice(0,-1),R]}return[...h,{type:"model",text:d,isFinal:!1}]})}(j=o.serverContent)!=null&&j.turnComplete&&u(d=>d.map(h=>v(k({},h),{isFinal:!0})));const C=(z=(F=(D=($=o.serverContent)==null?void 0:$.modelTurn)==null?void 0:D.parts[0])==null?void 0:F.inlineData)==null?void 0:z.data;if(C){const d=f.current;if(!d.outputAudioContext)return;d.nextStartTime=Math.max(d.nextStartTime,d.outputAudioContext.currentTime);const h=yield oe(re(C),d.outputAudioContext,24e3,1),l=d.outputAudioContext.createBufferSource();l.buffer=h,l.connect(d.outputAudioContext.destination),l.addEventListener("ended",()=>{d.sources.delete(l)}),l.start(d.nextStartTime),d.nextStartTime+=h.duration,d.sources.add(l)}}),onerror:o=>{x(`Connection error: ${o.message}`),r("error"),p()},onclose:()=>{r("idle"),p()}}})}catch(i){x(`Failed to start session: ${i.message}. Please ensure microphone permissions are granted.`),r("error"),p()}}),P=()=>{var i;(i=g.current)==null||i.then(w=>w.close())};S.useEffect(()=>()=>{p()},[p]);const T=()=>e.jsxs("div",{className:"flex-grow bg-gray-100 dark:bg-gray-800 rounded-lg p-6 space-y-4 overflow-y-auto",children:[c.map((i,w)=>e.jsx("div",{className:`flex ${i.type==="user"?"justify-end":"justify-start"}`,children:e.jsx("div",{className:`max-w-prose p-3 rounded-xl ${i.type==="user"?"bg-indigo-600 text-white":"bg-white dark:bg-gray-700"} ${i.isFinal?"":"opacity-70"}`,children:e.jsx("p",{children:i.text})})},w)),c.length===0&&s==="connected"&&e.jsxs("div",{className:"text-center text-gray-500 pt-16",children:[e.jsx(B,{size:48,className:"mx-auto mb-4 animate-pulse text-indigo-500"}),e.jsx("p",{className:"text-lg font-semibold",children:"جارٍ الاستماع..."}),e.jsx("p",{children:"ابدأ التحدث لطرح سؤال حول مشروعك."})]})]}),L=()=>{switch(s){case"idle":return e.jsxs(e.Fragment,{children:[e.jsx(V,{size:16}),e.jsx("span",{children:"غير متصل"})]});case"connecting":return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-slate-500"}),e.jsx("span",{children:"جاري الاتصال..."})]});case"connected":return e.jsxs(e.Fragment,{children:[e.jsx(J,{size:16,className:"text-green-500"}),e.jsx("span",{children:"متصل"})]});case"error":return e.jsxs(e.Fragment,{children:[e.jsx(Z,{size:16,className:"text-red-500"}),e.jsx("span",{children:"خطأ"})]})}};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("header",{className:"flex justify-between items-center mb-8 flex-wrap gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"المساعد المباشر"}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:["تحدث مباشرة مع مساعد الذكاء الاصطناعي حول مشروع: ",e.jsx("span",{className:"font-semibold",children:n.name})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{onClick:()=>a(!0),className:"flex items-center gap-2 text-slate-600 dark:text-slate-300 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:[e.jsx(_,{size:18}),e.jsx("span",{children:"تخصيص الشخصية"})]}),e.jsx("div",{className:"flex items-center gap-2 text-sm font-semibold text-slate-600 dark:text-slate-400",children:L()})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 border border-gray-200 dark:border-gray-800 p-6 rounded-xl shadow-sm flex-grow flex flex-col",children:[T(),b&&e.jsx("div",{className:"bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mt-4 rounded",role:"alert",children:e.jsx("p",{children:b})}),e.jsxs("div",{className:"pt-6 text-center",children:[s==="connected"||s==="connecting"?e.jsx("button",{onClick:P,disabled:s!=="connected",className:"bg-red-600 text-white rounded-full p-4 hover:bg-red-700 transition-colors disabled:bg-gray-400",children:e.jsx(Q,{size:24})}):e.jsx("button",{onClick:y,className:"bg-indigo-600 text-white rounded-full p-4 hover:bg-indigo-700 transition-colors",children:e.jsx(B,{size:24})}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-2",children:s==="connected"||s==="connecting"?"إيقاف المحادثة":"بدء المحادثة"})]})]}),e.jsx(ne,{isOpen:m,onClose:()=>a(!1),currentSettings:n.data.assistantSettings,onSave:i=>t(n.id,i)})]})};export{pe as LiveAssistant};
