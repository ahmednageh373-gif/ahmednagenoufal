var y=(t,u,l)=>new Promise((h,c)=>{var m=a=>{try{d(l.next(a))}catch(i){c(i)}},g=a=>{try{d(l.throw(a))}catch(i){c(i)}},d=a=>a.done?h(a.value):Promise.resolve(a.value).then(m,g);d((l=l.apply(t,u)).next())});import{r as n,j as e}from"./react-vendor-ITqvX6Xp.js";import{K as C}from"./index-ClqhgGpL.js";import{k as P}from"./utils-lib-C_gzCXPI.js";import{G as X}from"./GanttChart-DbnVOYHn.js";import{Q as _,R as L,V as R,K as T,Y as z}from"./icons-lib-Dd_BpYQ6.js";import"./vendor-8CkhJSGZ.js";import"./vendor-large-gsDFeA65.js";import"./genai-lib-pAIF5Ws4.js";const F=t=>{switch(t){case"crashed":return"bg-yellow-50 dark:bg-yellow-900/20";case"fast-tracked":return"bg-blue-50 dark:bg-blue-900/20";case"re-sequenced":return"bg-purple-50 dark:bg-purple-900/20";default:return""}},f=t=>{switch(t){case"crashed":return"تكثيف العمل";case"fast-tracked":return"مسار سريع";case"re-sequenced":return"معاد جدولته";default:return"بدون تغيير"}},O=({project:t,onUpdateSchedule:u})=>{const[l,h]=n.useState(!1),[c,m]=n.useState(""),[g,d]=n.useState(""),[a,i]=n.useState([]),w=t.endDate||new Date(new Date().setMonth(new Date().getMonth()+3)).toISOString().split("T")[0],[p,N]=n.useState(w),[b,v]=n.useState(t.startDate),{delayedTasks:j}=n.useMemo(()=>{const s=t.data.schedule||[],o=new Date;return o.setHours(0,0,0,0),{delayedTasks:s.filter(r=>r.progress<100&&new Date(r.end)<o)}},[t.data.schedule]),S=()=>y(null,null,function*(){if(!p&&!b){m("يرجى تحديد تاريخ بدء أو انتهاء جديد للمشروع.");return}h(!0),m(""),d(""),i([]);try{const s=b!==t.startDate,{plan:o,revisedSchedule:x}=yield C(t,p,s?b:void 0);d(o),i(x)}catch(s){m(s.message||"An unexpected error occurred during plan generation.")}finally{h(!1)}}),k=()=>{a.length!==0&&window.confirm("هل أنت متأكد من تطبيق هذه الخطة؟ سيتم استبدال الجدول الزمني الحالي بالجدول المعدل.")&&(u(t.id,a),alert("تم تطبيق خطة التعافي بنجاح."))},D=()=>{if(a.length===0)return;const s=a.map(r=>({ID:r.id,المهمة:r.name,"البدء الأصلي":r.originalStart,"الانتهاء الأصلي":r.originalEnd,"البدء المعدل":r.revisedStart,"الانتهاء المعدل":r.revisedEnd,"الإجراء المقترح":f(r.recoverySuggestion)})),o=XLSX.utils.json_to_sheet(s),x=XLSX.utils.book_new();XLSX.utils.book_append_sheet(x,o,"Recovery Plan"),XLSX.writeFile(x,`recovery_plan_${t.name.replace(/\s/g,"_")}.xlsx`)},E=()=>{window.print()};return e.jsxs("div",{className:"printable-area",children:[e.jsxs("header",{className:"flex justify-between items-center mb-8 flex-wrap gap-4 no-print",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"خطة التعافي / إعادة الجدولة"}),e.jsx("p",{className:"text-gray-500 mt-1",children:"إنشاء خطة لمعالجة التأخيرات أو إعادة جدولة المشروع."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:D,disabled:a.length===0,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-slate-400",children:[e.jsx(_,{size:18}),e.jsx("span",{children:"تصدير Excel"})]}),e.jsxs("button",{onClick:E,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(L,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border dark:border-gray-800 mb-8 no-print",children:[j.length>0&&e.jsx("div",{className:"bg-yellow-100 dark:bg-yellow-900/30 border-l-4 border-yellow-500 text-yellow-800 dark:text-yellow-200 p-4 rounded-md mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(R,{size:24}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold",children:"تنبيه: المشروع متأخر"}),e.jsxs("p",{children:["يوجد حاليًا ",j.length," مهمة متأخرة عن موعدها. يوصى بإنشاء خطة تعافي."]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new-start-date",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"إعادة جدولة من تاريخ بدء جديد"}),e.jsx("input",{id:"new-start-date",type:"date",value:b,onChange:s=>v(s.target.value),className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg border dark:border-gray-600"})]}),e.jsx("div",{className:"text-center text-sm font-semibold text-gray-500",children:"أو"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"new-end-date",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"خطة تعافي لتاريخ انتهاء جديد"}),e.jsx("input",{id:"new-end-date",type:"date",value:p,onChange:s=>N(s.target.value),className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg border dark:border-gray-600"})]})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsxs("button",{onClick:S,disabled:l,className:"flex items-center justify-center gap-2 bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 disabled:bg-slate-400 mx-auto",children:[l?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(T,{size:20}),e.jsx("span",{children:l?"...جاري إنشاء الخطة":"إنشاء الخطة بالذكاء الاصطناعي"})]})})]}),c&&e.jsx("div",{className:"bg-red-100 text-red-700 p-4 rounded my-4 no-print",children:c}),(g||a.length>0)&&e.jsxs("div",{className:"space-y-8",children:[e.jsx("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border dark:border-gray-800",children:e.jsx("div",{className:"prose dark:prose-invert max-w-none",dangerouslySetInnerHTML:{__html:P.parse(g)}})}),e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border dark:border-gray-800",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"مقارنة الجدول الزمني"}),e.jsxs("button",{onClick:k,className:"no-print flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(z,{size:18}),e.jsx("span",{children:"تطبيق الخطة"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right text-sm responsive-table",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b dark:border-gray-700",children:[e.jsx("th",{className:"p-2",children:"المهمة"}),e.jsx("th",{className:"p-2",children:"البدء الأصلي"}),e.jsx("th",{className:"p-2",children:"البدء المعدل"}),e.jsx("th",{className:"p-2",children:"الانتهاء الأصلي"}),e.jsx("th",{className:"p-2",children:"الانتهاء المعدل"}),e.jsx("th",{className:"p-2",children:"الإجراء"})]})}),e.jsx("tbody",{children:a.map(s=>e.jsxs("tr",{className:`border-b dark:border-gray-700 last:border-0 ${F(s.recoverySuggestion)}`,children:[e.jsx("td",{className:"p-2 font-medium","data-label":"المهمة",children:s.name}),e.jsx("td",{className:"p-2 font-mono","data-label":"البدء الأصلي",children:e.jsx("del",{children:s.originalStart})}),e.jsx("td",{className:"p-2 font-mono font-semibold","data-label":"البدء المعدل",children:s.revisedStart}),e.jsx("td",{className:"p-2 font-mono","data-label":"الانتهاء الأصلي",children:e.jsx("del",{children:s.originalEnd})}),e.jsx("td",{className:"p-2 font-mono font-semibold","data-label":"الانتهاء المعدل",children:s.revisedEnd}),e.jsx("td",{className:"p-2 font-semibold","data-label":"الإجراء",children:f(s.recoverySuggestion)})]},s.id))})]})})]}),e.jsxs("div",{className:"printable-gantt",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"مخطط جانت المعدل"}),e.jsx(X,{tasks:a,members:t.data.members||[],projectStartDate:t.startDate,cpmResult:null})]})]})]})};export{O as RecoveryPlanner};
