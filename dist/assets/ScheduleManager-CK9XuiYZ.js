var Ie=Object.defineProperty,Me=Object.defineProperties;var Ee=Object.getOwnPropertyDescriptors;var he=Object.getOwnPropertySymbols;var Xe=Object.prototype.hasOwnProperty,ze=Object.prototype.propertyIsEnumerable;var ue=(t,a,s)=>a in t?Ie(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s,q=(t,a)=>{for(var s in a||(a={}))Xe.call(a,s)&&ue(t,s,a[s]);if(he)for(var s of he(a))ze.call(a,s)&&ue(t,s,a[s]);return t},te=(t,a)=>Me(t,Ee(a));var ae=(t,a,s)=>new Promise((l,j)=>{var m=f=>{try{b(s.next(f))}catch(u){j(u)}},N=f=>{try{b(s.throw(f))}catch(u){j(u)}},b=f=>f.done?l(f.value):Promise.resolve(f.value).then(m,N);b((s=s.apply(t,a)).next())});import{r as i,j as e}from"./react-vendor-D4cZjflF.js";import{g as Ae,a as Le,b as Pe,c as _e,G as Oe}from"./GanttChart-26w6AC9U.js";import{l as $e,X as le,$ as Be,a0 as We,R as de,P as be,a1 as Re,a2 as Ge,a3 as He,a4 as qe,b as Qe,_ as Je,U as Ve,a5 as Ke,a6 as Ye,a7 as Ze,a8 as Ue,a9 as pe}from"./icons-lib-DeXvYHHd.js";import{a as es,b as ss,c as ts,d as as}from"./index-Cogjp2r_.js";import{k as ls}from"./utils-lib-CuOuuFHP.js";import"./vendor-DhnXlGBj.js";import"./vendor-large-CMFjXBcn.js";import"./genai-lib-BGDjQqRJ.js";const rs=({members:t,selectedMemberIds:a,onSelectionChange:s,maxSelection:l,label:j="تعيين الأعضاء",placeholder:m="ابحث عن الأعضاء...",className:N=""})=>{const[b,f]=i.useState(!1),[u,M]=i.useState(""),S=i.useMemo(()=>t.filter(r=>a.includes(r.id)),[t,a]),z=i.useMemo(()=>{if(!u)return t;const r=u.toLowerCase();return t.filter(g=>g.name.toLowerCase().includes(r)||g.email.toLowerCase().includes(r)||g.role.toLowerCase().includes(r))},[t,u]),D=r=>{if(a.includes(r))s(a.filter(g=>g!==r));else{if(l&&a.length>=l)return;s([...a,r])}},y=(r,g)=>{g.stopPropagation(),s(a.filter(C=>C!==r))},E=({member:r,size:g="md"})=>{const C={sm:"w-6 h-6 text-xs",md:"w-8 h-8 text-sm",lg:"w-10 h-10 text-base"},L=Le(r.name),$=r.avatarColor||Pe(r.name),O=_e($);return r.avatar?e.jsx("img",{src:r.avatar,alt:r.name,className:`${C[g]} rounded-full object-cover`}):e.jsx("div",{className:`${C[g]} rounded-full flex items-center justify-center font-semibold`,style:{backgroundColor:$,color:O},children:L})};return e.jsxs("div",{className:`relative ${N}`,children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:j}),e.jsx("div",{onClick:()=>f(!b),className:"min-h-[42px] px-3 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:border-indigo-500 dark:hover:border-indigo-400 transition-colors",children:S.length===0?e.jsxs("div",{className:"flex items-center gap-2 text-gray-400 dark:text-gray-500",children:[e.jsx($e,{size:16}),e.jsx("span",{className:"text-sm",children:"لم يتم تعيين أعضاء"})]}):e.jsx("div",{className:"flex flex-wrap gap-2",children:S.map(r=>e.jsxs("div",{className:"flex items-center gap-2 px-2 py-1 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg group",children:[e.jsx(E,{member:r,size:"sm"}),e.jsx("span",{className:"text-sm font-medium text-gray-700 dark:text-gray-300",children:r.name}),e.jsx("button",{onClick:g=>y(r.id,g),className:"text-gray-400 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100",children:e.jsx(le,{size:14})})]},r.id))})}),b&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>f(!1)}),e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl z-20 max-h-96 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"p-3 border-b border-gray-200 dark:border-gray-700",children:e.jsxs("div",{className:"relative",children:[e.jsx(Be,{size:18,className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"}),e.jsx("input",{type:"text",value:u,onChange:r=>M(r.target.value),placeholder:m,className:"w-full pl-10 pr-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right",autoFocus:!0})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:z.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500 dark:text-gray-400",children:"لا توجد نتائج"}):z.map(r=>{const g=a.includes(r.id),C=l&&a.length>=l&&!g;return e.jsxs("div",{onClick:()=>!C&&D(r.id),className:`p-3 flex items-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors ${C?"opacity-50 cursor-not-allowed":"cursor-pointer"} ${g?"bg-indigo-50 dark:bg-indigo-900/20":""}`,children:[e.jsx(E,{member:r,size:"md"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"font-medium text-gray-900 dark:text-gray-100 truncate",children:r.name}),e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${Ae(r.role)}`,children:r.role})]}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400 truncate",children:r.email})]}),g&&e.jsx("div",{className:"flex-shrink-0 w-5 h-5 bg-indigo-500 rounded-full flex items-center justify-center",children:e.jsx(We,{size:14,className:"text-white"})})]},r.id)})}),l&&e.jsxs("div",{className:"p-2 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-xs text-gray-500 dark:text-gray-400 text-center",children:[a.length," / ",l," محدد"]})]})]})]})},ns=({isOpen:t,onClose:a,onSave:s,task:l,allTasks:j,members:m})=>{const[N,b]=i.useState(""),[f,u]=i.useState(""),[M,S]=i.useState(""),[z,D]=i.useState(0),[y,E]=i.useState([]),[r,g]=i.useState([]),[C,L]=i.useState("To Do"),[$,O]=i.useState("Medium"),[B,Z]=i.useState(""),[Q,J]=i.useState(""),[re,T]=i.useState(""),[U,ee]=i.useState(!1);i.useEffect(()=>{if(t)if(l)b(l.name),u(l.start),S(l.end),D(l.progress),E(l.dependencies||[]),g(l.assignees||[]),L(l.status||"To Do"),O(l.priority||"Medium"),Z(l.category||""),J(l.baselineStart||""),T(l.baselineEnd||""),ee(!!(l.baselineStart||l.baselineEnd));else{const d=new Date().toISOString().split("T")[0];b(""),u(d),S(d),D(0),E([]),g([]),L("To Do"),O("Medium"),Z(""),J(""),T(""),ee(!1)}},[l,t]);const oe=d=>{if(d.preventDefault(),!N.trim()||!f||!M)return;const V={name:N,start:f,end:M,progress:z,dependencies:y,assignees:r,status:C,priority:$,category:B,baselineStart:Q||void 0,baselineEnd:re||void 0};s(l?q(q({},l),V):V),a()};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center",onClick:a,children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl p-8 w-full max-w-2xl mx-4",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:l?"تعديل المهمة":"إضافة مهمة جديدة"}),e.jsx("button",{onClick:a,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(le,{size:24})})]}),e.jsxs("form",{onSubmit:oe,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"taskName",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"اسم المهمة"}),e.jsx("input",{id:"taskName",type:"text",value:N,onChange:d=>b(d.target.value),required:!0,className:"w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"taskStart",className:"block text-sm font-medium mb-2",children:"تاريخ البدء"}),e.jsx("input",{id:"taskStart",type:"date",value:f,onChange:d=>u(d.target.value),required:!0,className:"w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"taskEnd",className:"block text-sm font-medium mb-2",children:"تاريخ الانتهاء"}),e.jsx("input",{id:"taskEnd",type:"date",value:M,onChange:d=>S(d.target.value),required:!0,className:"w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg"})]})]}),e.jsxs("div",{className:"mb-4 p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-lg border border-indigo-200 dark:border-indigo-800",children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-sm font-semibold text-indigo-900 dark:text-indigo-100",children:"تواريخ الأساس (Baseline)"}),e.jsx("button",{type:"button",onClick:()=>ee(!U),className:"text-xs px-3 py-1 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition-colors",children:U?"إخفاء":"إضافة أساس"})]}),U&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"baselineStart",className:"block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1",children:"تاريخ بدء الأساس"}),e.jsx("input",{id:"baselineStart",type:"date",value:Q,onChange:d=>J(d.target.value),className:"w-full bg-white dark:bg-slate-700 p-2 rounded-lg text-sm border border-indigo-300 dark:border-indigo-700"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"التاريخ المخطط الأصلي للبدء"})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"baselineEnd",className:"block text-xs font-medium text-slate-600 dark:text-slate-400 mb-1",children:"تاريخ انتهاء الأساس"}),e.jsx("input",{id:"baselineEnd",type:"date",value:re,onChange:d=>T(d.target.value),className:"w-full bg-white dark:bg-slate-700 p-2 rounded-lg text-sm border border-indigo-300 dark:border-indigo-700"}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:"التاريخ المخطط الأصلي للانتهاء"})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("label",{htmlFor:"taskProgress",className:"block text-sm font-medium mb-2",children:["التقدم (",z,"%)"]}),e.jsx("input",{id:"taskProgress",type:"range",min:"0",max:"100",value:z,onChange:d=>D(parseInt(d.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"taskDependencies",className:"block text-sm font-medium mb-2",children:"تعتمد على"}),e.jsx("select",{id:"taskDependencies",multiple:!0,value:y.map(String),onChange:d=>E(Array.from(d.target.selectedOptions,V=>Number(V.value))),className:"w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg h-32",children:j.filter(d=>d.id!==(l==null?void 0:l.id)).map(d=>e.jsx("option",{value:d.id,children:d.name},d.id))})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"taskStatus",className:"block text-sm font-medium mb-2",children:"الحالة"}),e.jsxs("select",{id:"taskStatus",value:C,onChange:d=>L(d.target.value),className:"w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg",children:[e.jsx("option",{value:"To Do",children:"To Do"}),e.jsx("option",{value:"In Progress",children:"In Progress"}),e.jsx("option",{value:"Done",children:"Done"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"taskPriority",className:"block text-sm font-medium mb-2",children:"الأولوية"}),e.jsxs("select",{id:"taskPriority",value:$,onChange:d=>O(d.target.value),className:"w-full bg-slate-100 dark:bg-slate-700 p-2 rounded-lg",children:[e.jsx("option",{value:"Low",children:"Low"}),e.jsx("option",{value:"Medium",children:"Medium"}),e.jsx("option",{value:"High",children:"High"})]})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(rs,{members:m,selectedMemberIds:r,onSelectionChange:g,label:"المسؤولون عن المهمة",placeholder:"ابحث عن الأعضاء..."})}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 rounded-lg bg-slate-200 dark:bg-slate-600",children:"إلغاء"}),e.jsx("button",{type:"submit",className:"px-4 py-2 rounded-lg bg-sky-600 text-white",children:"حفظ"})]})]})]})}):null},is=({isOpen:t,onClose:a,onAddTasks:s})=>{const[l,j]=i.useState("أعمال الواجهات الخارجية للمبنى الرئيسي"),[m,N]=i.useState(!1),[b,f]=i.useState(""),[u,M]=i.useState([]),S=()=>ae(null,null,function*(){if(l.trim()){N(!0),f(""),M([]);try{const y=yield es(l);M(y)}catch(y){f(y.message)}finally{N(!1)}}}),z=()=>{s(u),a()},D=()=>{j("أعمال الواجهات الخارجية للمبنى الرئيسي"),M([]),f(""),N(!1),a()};return t?e.jsx("div",{className:"modal",style:{display:"block"},onClick:D,children:e.jsxs("div",{className:"modal-content p-8 max-w-3xl dark:bg-gray-800",onClick:y=>y.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"المحلل الذكي للمهام"}),e.jsx("button",{onClick:D,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(le,{size:24})})]}),e.jsx("p",{className:"mb-4 text-slate-600 dark:text-slate-400",children:"اكتب وصفًا لنشاط أو مرحلة عمل، وسيقوم الذكاء الاصطناعي بتقسيمها إلى مهام فرعية مفصلة مع تقدير للمدد والترتيب المنطقي."}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"taskDescription",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"وصف النشاط"}),e.jsx("textarea",{id:"taskDescription",value:l,onChange:y=>j(y.target.value),rows:4,placeholder:"مثال: تشطيبات الطابق الأول",className:"w-full bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:S,disabled:m||!l.trim(),className:"px-4 py-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 flex items-center gap-2 disabled:bg-gray-400",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"...جاري التوليد"})]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{size:18}),e.jsx("span",{children:"توليد المهام"})]})})}),b&&e.jsx("p",{className:"text-red-500 text-sm mt-4",children:b}),u.length>0&&e.jsxs("div",{className:"mt-6 border-t border-gray-200 dark:border-gray-700 pt-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"المهام المقترحة:"}),e.jsx("div",{className:"max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg",children:e.jsxs("table",{className:"w-full text-right text-sm",children:[e.jsx("thead",{className:"bg-gray-50 dark:bg-gray-900/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:"المهمة"}),e.jsx("th",{className:"p-2",children:"المدة (أيام)"}),e.jsx("th",{className:"p-2",children:"تعتمد على"})]})}),e.jsx("tbody",{children:u.map((y,E)=>e.jsxs("tr",{className:"border-b border-gray-200 dark:border-gray-700 last:border-b-0",children:[e.jsx("td",{className:"p-2 font-medium",children:y.name}),e.jsx("td",{className:"p-2 text-center",children:y.duration}),e.jsx("td",{className:"p-2",children:y.predecessors.join(", ")||"لا يوجد"})]},E))})]})}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx("button",{type:"button",onClick:D,className:"px-4 py-2 rounded-lg text-slate-700 dark:text-slate-200 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 font-semibold",children:"إلغاء"}),e.jsxs("button",{type:"button",onClick:z,className:"px-4 py-2 rounded-lg text-white bg-green-600 hover:bg-green-700 font-semibold flex items-center gap-2",children:[e.jsx(be,{size:18}),"إضافة المهام للجدول"]})]})]})]})}):null},ds=({isOpen:t,onClose:a,onConfirm:s,tasks:l,fileName:j})=>t?e.jsx("div",{className:"modal",style:{display:"block"},onClick:a,children:e.jsxs("div",{className:"modal-content p-8 max-w-4xl dark:bg-gray-800",onClick:m=>m.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"تأكيد استيراد الجدول الزمني"}),e.jsx("button",{onClick:a,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(le,{size:24})})]}),e.jsxs("p",{className:"mb-4 text-slate-600 dark:text-slate-400",children:["تمت قراءة المهام التالية من الملف ",e.jsx("span",{className:"font-semibold",children:j}),". سيؤدي التأكيد إلى استبدال الجدول الزمني الحالي."]}),l.length>0?e.jsx("div",{className:"max-h-96 overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg",children:e.jsxs("table",{className:"w-full text-right text-sm",children:[e.jsx("thead",{className:"bg-slate-50 dark:bg-slate-900/50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2",children:"المهمة"}),e.jsx("th",{className:"p-2",children:"تاريخ البدء"}),e.jsx("th",{className:"p-2",children:"تاريخ الانتهاء"}),e.jsx("th",{className:"p-2",children:"الاعتماديات"})]})}),e.jsx("tbody",{children:l.map((m,N)=>e.jsxs("tr",{className:"border-b border-slate-200 dark:border-slate-700 last:border-b-0",children:[e.jsx("td",{className:"p-2 font-medium",children:m.name}),e.jsx("td",{className:"p-2",children:m.start}),e.jsx("td",{className:"p-2",children:m.end}),e.jsx("td",{className:"p-2",children:m.dependencies.join(", ")})]},m.id||N))})]})}):e.jsxs("div",{className:"text-center p-12 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg",children:[e.jsx(Re,{size:48,className:"mx-auto text-yellow-500 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-yellow-800 dark:text-yellow-200",children:"لم يتم العثور على مهام"}),e.jsx("p",{className:"text-yellow-700 dark:text-yellow-300",children:"لم يتمكن النظام من قراءة أي مهام. يرجى التأكد من أن الملف يحتوي على الأعمدة الصحيحة (المهمة, تاريخ البدء, تاريخ الانتهاء)."})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-6",children:[e.jsx("button",{type:"button",onClick:a,className:"px-4 py-2 rounded-lg text-slate-700 dark:text-slate-200 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500",children:"إلغاء"}),e.jsxs("button",{type:"button",onClick:()=>s(l),disabled:l.length===0,className:"px-4 py-2 rounded-lg text-white bg-green-600 hover:bg-green-700 flex items-center gap-2 disabled:bg-gray-400",children:[e.jsx(Ge,{size:18}),"تأكيد واستبدال"]})]})]})}):null,os=({isOpen:t,onClose:a,onAnalyze:s,isLoading:l,result:j})=>{const[m,N]=i.useState("ماذا لو تأخرت أعمال الحفر لمدة 15 يومًا؟");return t?e.jsx("div",{className:"modal",style:{display:"block"},onClick:a,children:e.jsxs("div",{className:"modal-content p-8 max-w-3xl dark:bg-gray-800",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:'تحليل "ماذا لو؟"'}),e.jsx("button",{onClick:a,children:e.jsx(le,{size:24})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"what-if-query",className:"block text-sm font-medium mb-2",children:"سيناريو افتراضي"}),e.jsx("textarea",{id:"what-if-query",value:m,onChange:b=>N(b.target.value),rows:4,placeholder:"مثال: ما هو تأثير زيادة الموارد في بند الهيكل الخرساني بنسبة 30% على تاريخ الانتهاء؟",className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs("button",{onClick:()=>s(m),disabled:l||!m.trim(),className:"flex items-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 disabled:bg-slate-400",children:[l?e.jsx(He,{className:"animate-spin"}):e.jsx(de,{}),e.jsx("span",{children:l?"جاري التحليل...":"تحليل السيناريو"})]})}),j&&!l&&e.jsxs("div",{className:"mt-6 border-t pt-6",children:[e.jsx("h3",{className:"text-xl font-semibold mb-4",children:"نتائج التحليل"}),e.jsx("div",{className:"prose dark:prose-invert max-w-none text-sm bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg",dangerouslySetInnerHTML:{__html:ls.parse(j.impactSummary)}}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 text-center",children:[e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-700 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs font-semibold",children:"تاريخ الانتهاء الجديد"}),e.jsx("p",{className:"font-bold text-lg text-red-500",children:j.newEndDate})]}),e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-700 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs font-semibold",children:"التأثير على التكلفة"}),e.jsx("p",{className:"text-sm",children:j.costImpact})]}),e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-700 p-3 rounded-lg",children:[e.jsx("p",{className:"text-xs font-semibold",children:"التأثير على المسار الحرج"}),e.jsx("p",{className:"text-sm",children:j.criticalPathImpact})]})]})]})]})}):null},ie=({icon:t,label:a,value:s})=>e.jsxs("div",{className:"bg-slate-100 dark:bg-slate-800 p-4 rounded-lg flex items-center gap-4",children:[e.jsx(t,{className:"w-6 h-6 text-indigo-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400",children:a}),e.jsx("p",{className:"text-xl font-bold",children:s})]})]}),ys=({project:t,onUpdateSchedule:a})=>{const s=t.data.schedule||[],l=t.data.members||[],[j,m]=i.useState(!1),[N,b]=i.useState(!1),[f,u]=i.useState(!1),[M,S]=i.useState([]),[z,D]=i.useState(""),[y,E]=i.useState(null),[r,g]=i.useState(!1),[C,L]=i.useState(null),[$,O]=i.useState(!1),[B,Z]=i.useState(null),[Q,J]=i.useState(!1),re=i.useRef(null),T=i.useMemo(()=>{if(s.length===0)return{totalTasks:0,overallDuration:0,startDate:t.startDate,endDate:t.endDate||t.startDate};const n=s.map(v=>new Date(v.start).getTime()),x=s.map(v=>new Date(v.end).getTime()),o=new Date(Math.min(...n)),h=new Date(Math.max(...x)),F=Math.ceil((h.getTime()-o.getTime())/(1e3*60*60*24))+1;return{totalTasks:s.length,overallDuration:(B==null?void 0:B.projectDuration)||F,startDate:o.toISOString().split("T")[0],endDate:h.toISOString().split("T")[0]}},[s,t.startDate,t.endDate,B]),U=()=>{E(null),m(!0)},ee=i.useCallback(n=>{E(n),m(!0)},[]),oe=n=>{let x;if("id"in n)x=s.map(o=>o.id===n.id?n:o);else{const o=s.length>0?Math.max(...s.map(F=>F.id))+1:1,h=te(q({},n),{id:o});x=[...s,h]}a(t.id,x)},d=i.useCallback(n=>{if(window.confirm("هل أنت متأكد من حذف هذه المهمة؟")){const x=s.filter(o=>o.id!==n).map(o=>te(q({},o),{dependencies:o.dependencies.filter(h=>h!==n)}));a(t.id,x)}},[t.id,s,a]),V=n=>{let x=[...s],o=x.length>0?Math.max(...x.map(k=>k.id)):0;const h=[],F={};n.forEach(k=>{o++;const A={id:o,name:k.name,progress:0,dependencies:k.predecessors,category:"Generated",status:"To Do",priority:"Medium",assignees:[]};h.push(A),F[k.name]=o});const v=h.map((k,A)=>{const K=n[A],W=K.predecessors.map(p=>F[p]).filter(Boolean);let P=new Date(t.startDate);if(W.length>0){const p=W.map(X=>{const I=x.find(_=>_.id===X)||h.find(_=>_.id===X);return I?new Date(I.end||t.startDate):new Date(t.startDate)});P=new Date(Math.max(...p.map(X=>X.getTime()))),P.setDate(P.getDate()+1)}const R=new Date(P);return R.setDate(R.getDate()+(K.duration-1)),te(q({},k),{dependencies:W,start:P.toISOString().split("T")[0],end:R.toISOString().split("T")[0]})});a(t.id,[...x,...v])},fe=n=>{var h;const x=(h=n.target.files)==null?void 0:h[0];if(!x)return;D(x.name);const o=new FileReader;o.onload=F=>{var v;try{const k=(v=F.target)==null?void 0:v.result,A=XLSX.read(k,{type:"binary"}),K=A.SheetNames[0],W=A.Sheets[K],R=XLSX.utils.sheet_to_json(W).map((p,X)=>{const I=G=>new Date(Date.UTC(0,0,G-1)),_=typeof p["تاريخ البدء"]=="number"?I(p["تاريخ البدء"]).toISOString().split("T")[0]:p["تاريخ البدء"],se=typeof p["تاريخ الانتهاء"]=="number"?I(p["تاريخ الانتهاء"]).toISOString().split("T")[0]:p["تاريخ الانتهاء"];return{id:p.ID||X+1,name:p.المهمة||"مهمة غير مسماة",start:_,end:se,progress:p.التقدم||0,dependencies:p.الاعتماديات?String(p.الاعتماديات).split(",").map(Number).filter(G=>!isNaN(G)):[],category:p.الفئة||"مستورد",status:p.الحالة||"To Do",priority:p.الأولوية||"Medium",assignees:p.المسؤولون?String(p.المسؤولون).split(",").map(G=>G.trim()):[]}});S(R),u(!0)}catch(k){alert(`فشل في قراءة الملف: ${k.message}`)}},o.readAsBinaryString(x),n.target.value=""},je=n=>{var h;const x=(h=n.target.files)==null?void 0:h[0];if(!x)return;D(x.name),u(!0),S([]);const o=new FileReader;o.onload=F=>ae(null,null,function*(){var v;try{const k=(v=F.target)==null?void 0:v.result,A=yield ss(k);S(A)}catch(k){alert(`فشل تحليل ملف XER: ${k.message}`),u(!1)}}),o.readAsText(x),n.target.value=""},ye=n=>{a(t.id,n),u(!1)},Ne=()=>{if(s.length===0)return;const n=XLSX.utils.book_new(),x=[["اسم المشروع:",t.name],["الوصف:",t.description],["تاريخ الإنشاء:",new Date().toLocaleDateString("ar-SA")],[],["إجمالي المهام:",T.totalTasks],["المدة الكلية (أيام):",T.overallDuration],["تاريخ البدء:",T.startDate],["تاريخ الانتهاء:",T.endDate]],o=XLSX.utils.aoa_to_sheet(x);o["!cols"]=[{wch:20},{wch:50}],o.A1.s={font:{bold:!0}},o.A2.s={font:{bold:!0}},XLSX.utils.book_append_sheet(n,o,"Cover Page");const h=s.map(c=>({WBS:c.wbsCode||"-",ID:c.id,"Activity Name":c.name,Duration:Math.ceil((new Date(c.end).getTime()-new Date(c.start).getTime())/(1e3*60*60*24))+1,"Start Date":c.start,"End Date":c.end,Predecessors:c.dependencies.join(", "),Resources:(c.resourcesNeeded||[]).join(", ")})),F=XLSX.utils.json_to_sheet(h);XLSX.utils.book_append_sheet(n,F,"Schedule Data");const v={font:{bold:!0,color:{rgb:"FFFFFFFF"}},fill:{fgColor:{rgb:"FF1F4E78"}}},k={font:{bold:!0}},A={fill:{fgColor:{rgb:"FFF1F5F9"}}},K={fill:{fgColor:{rgb:"FF3B82F6"}}},W={fill:{fgColor:{rgb:"FF60A5FA"}}},P=s.flatMap(c=>[new Date(c.start),new Date(c.end)]),R=new Date(Math.min(...P.map(c=>c.getTime()))),p=new Date(Math.max(...P.map(c=>c.getTime())));let X=new Date(R);const I=[];for(;X<=p;)I.push(new Date(X)),X.setDate(X.getDate()+1);const _=[],se=["المهمة","تاريخ البدء","تاريخ الانتهاء"],G=I.map(c=>c.toLocaleDateString("ar-SA",{day:"2-digit",month:"short"}));_.push([...se,...G]),s.forEach(c=>{const Y=[c.name,c.start,c.end];_.push([...Y,...I.map(()=>"")])});const w=XLSX.utils.aoa_to_sheet(_);Object.keys(v).length>0&&XLSX.utils.sheet_add_aoa(w,[[]],{origin:-1});for(let c=0;c<se.length+I.length;++c){const Y=XLSX.utils.encode_cell({r:0,c});w[Y]&&(w[Y].s=v)}s.forEach((c,Y)=>{const xe=Y+1;w[`A${xe}`].s=k;const ce=new Date(c.start),me=new Date(c.end);I.forEach((ne,De)=>{const Ce=se.length+De,H=XLSX.utils.encode_cell({r:xe,c:Ce}),ge=ne.getDay();if((ge===4||ge===5)&&(w[H]=w[H]||{},w[H].s=A),ne>=ce&&ne<=me){w[H]=w[H]||{};const Te=c.progress/100,Fe=(me.getTime()-ce.getTime())/(1e3*60*60*24)+1;(ne.getTime()-ce.getTime())/(1e3*60*60*24)<Fe*Te?w[H].s=W:w[H].s=K}})}),w["!cols"]=[{wch:40},{wch:12},{wch:12},...I.map(()=>({wch:10}))],XLSX.utils.book_append_sheet(n,w,"Visual Gantt Chart"),XLSX.writeFile(n,`professional_schedule_${t.name.replace(/\s/g,"_")}.xlsx`)},ke=()=>{window.print()},ve=n=>ae(null,null,function*(){if(s.length===0){alert("لا يمكن إجراء التحليل على جدول زمني فارغ.");return}O(!0),L(null);try{const x=yield as(s,n);L(x)}catch(x){alert(`فشل تحليل "ماذا لو؟": ${x.message}`)}finally{O(!1)}}),we=()=>ae(null,null,function*(){if(s.length===0){alert("لا يمكن تحليل المسار الحرج لجدول فارغ.");return}J(!0);try{const n=yield ts(s);Z(n),alert(`تم تحليل المسار الحرج بنجاح. المدة الجديدة للمشروع هي ${n.projectDuration} يوم. تم تلوين المهام الحرجة باللون الأحمر.`)}catch(n){alert(`فشل تحليل المسار الحرج: ${n.message}`),Z(null)}finally{J(!1)}}),Se=()=>{if(s.length===0){alert("لا يمكن تعيين الأساس لجدول فارغ.");return}const n=s.filter(o=>o.baselineStart||o.baselineEnd),x=n.length>0?`يوجد ${n.length} مهمة لديها تواريخ أساس بالفعل. هل تريد استبدالها بالتواريخ الحالية؟`:`سيتم تعيين التواريخ الحالية كتواريخ أساس لجميع المهام (${s.length} مهمة). هل تريد المتابعة؟`;if(window.confirm(x)){const o=s.map(h=>te(q({},h),{baselineStart:h.start,baselineEnd:h.end,baselineProgress:h.progress}));a(t.id,o),alert(`✅ تم تعيين الأساس بنجاح ل ${s.length} مهمة`)}};return e.jsxs("div",{children:[e.jsxs("header",{className:"flex justify-between items-center mb-8 flex-wrap gap-4 no-print",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 dark:text-white",children:"إدارة الجدول الزمني"}),e.jsxs("p",{className:"text-gray-500 dark:text-gray-400 mt-1",children:["تخطيط وتتبع المهام لمشروع: ",e.jsx("span",{className:"font-semibold",children:t.name})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap justify-end",children:[e.jsxs("button",{onClick:Se,className:"flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700",children:[e.jsx(qe,{size:18}),e.jsx("span",{children:"تعيين الأساس"})]}),e.jsxs("button",{onClick:Ne,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(Qe,{size:18}),e.jsx("span",{children:"تصدير Excel احترافي"})]}),e.jsxs("button",{onClick:ke,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(Je,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]}),e.jsxs("label",{className:"flex items-center gap-2 bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-800 cursor-pointer",children:[e.jsx(Ve,{size:18}),e.jsx("span",{children:"استيراد Excel"}),e.jsx("input",{type:"file",onChange:fe,accept:".xlsx, .xls",className:"hidden"})]}),e.jsxs("label",{className:"flex items-center gap-2 bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-orange-700 cursor-pointer",children:[e.jsx(Ke,{size:18}),e.jsx("span",{children:"استيراد Primavera (.xer)"}),e.jsx("input",{type:"file",ref:re,onChange:je,accept:".xer",className:"hidden"})]}),e.jsxs("button",{onClick:we,disabled:Q,className:"flex items-center gap-2 bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 disabled:bg-slate-400",children:[Q?e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}):e.jsx(Ye,{size:18}),e.jsx("span",{children:Q?"...جارٍ التحليل":"تحليل المسار الحرج"})]}),e.jsxs("button",{onClick:()=>g(!0),className:"flex items-center gap-2 bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-purple-700",children:[e.jsx(de,{size:18}),e.jsx("span",{children:'تحليل "ماذا لو؟" (AI)'})]}),e.jsxs("button",{onClick:()=>b(!0),className:"flex items-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700",children:[e.jsx(de,{size:18}),e.jsx("span",{children:"إنشاء مهام فرعية (AI)"})]}),e.jsxs("button",{onClick:U,className:"flex items-center gap-2 bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700",children:[e.jsx(be,{size:18}),e.jsx("span",{children:"إضافة مهمة"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 no-print",children:[e.jsx(ie,{icon:Ze,label:"إجمالي المهام",value:T.totalTasks}),e.jsx(ie,{icon:Ue,label:"المدة الكلية (أيام)",value:T.overallDuration}),e.jsx(ie,{icon:pe,label:"تاريخ البدء",value:T.startDate}),e.jsx(ie,{icon:pe,label:"تاريخ الانتهاء",value:T.endDate})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsx("div",{className:"min-w-[1000px] printable-gantt",children:e.jsx(Oe,{tasks:s,members:l,projectStartDate:t.startDate,onEditTask:ee,onDeleteTask:d,cpmResult:B})})}),e.jsx(ns,{isOpen:j,onClose:()=>m(!1),onSave:oe,task:y,allTasks:s,members:l}),e.jsx(is,{isOpen:N,onClose:()=>b(!1),onAddTasks:V}),e.jsx(ds,{isOpen:f,onClose:()=>u(!1),onConfirm:ye,tasks:M,fileName:z}),e.jsx(os,{isOpen:r,onClose:()=>{g(!1),L(null)},onAnalyze:ve,isLoading:$,result:C})]})};export{ys as ScheduleManager};
