var O=Object.defineProperty,U=Object.defineProperties;var R=Object.getOwnPropertyDescriptors;var T=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var M=(t,a,r)=>a in t?O(t,a,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[a]=r,j=(t,a)=>{for(var r in a||(a={}))Q.call(a,r)&&M(t,r,a[r]);if(T)for(var r of T(a))W.call(a,r)&&M(t,r,a[r]);return t},k=(t,a)=>U(t,R(a));var P=(t,a,r)=>new Promise((g,n)=>{var i=s=>{try{x(r.next(s))}catch(l){n(l)}},o=s=>{try{x(r.throw(s))}catch(l){n(l)}},x=s=>s.done?g(s.value):Promise.resolve(s.value).then(i,o);x((r=r.apply(t,a)).next())});import{r as c,j as e}from"./react-vendor-ITqvX6Xp.js";import{m as B,n as G}from"./index-CmtUYdlp.js";import{X as F,m as $,aa as H,Q as V,ab as K,a1 as q,N as J,O as Y,ac as E,s as Z,ad as X,P as _,ae as ee,I as se,af as te}from"./icons-lib-BklrIGsN.js";import{k as ae,v as le}from"./utils-lib-C_gzCXPI.js";import"./vendor-8CkhJSGZ.js";import"./vendor-large-gsDFeA65.js";import"./genai-lib-pAIF5Ws4.js";const re=({isOpen:t,onClose:a,project:r,onUpdateSiteLog:g})=>{const[n,i]=c.useState(null),[o,x]=c.useState(null),[s,l]=c.useState(""),[p,v]=c.useState(!1),[y,b]=c.useState(""),[S,C]=c.useState(null),[I,w]=c.useState("idle"),A=c.useRef(null);c.useEffect(()=>{t?(w("loading"),navigator.geolocation.getCurrentPosition(u=>{C({lat:u.coords.latitude,lng:u.coords.longitude}),w("success")},()=>{w("error")})):(C(null),w("idle"))},[t]);const D=()=>{i(null),x(null),l(""),v(!1),b(""),C(null),w("idle")},d=()=>{D(),a()},h=u=>{var z;const N=(z=u.target.files)==null?void 0:z[0];if(N){i(N);const L=new FileReader;L.onloadend=()=>{x(L.result)},L.readAsDataURL(N)}},f=u=>P(null,null,function*(){if(u.preventDefault(),!n){b("يرجى رفع صورة.");return}v(!0),b("");try{const N=yield B(s,n),z=j({id:`log-${Date.now()}`,date:new Date().toISOString(),photoUrl:o,userNotes:s,aiAnalysis:N},S&&{latitude:S.lat,longitude:S.lng}),L=[...r.data.siteLog||[],z];g(r.id,L),d()}catch(N){b(N.message||"حدث خطأ غير متوقع أثناء التحليل.")}finally{v(!1)}}),m=()=>{switch(I){case"loading":return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-500",children:[e.jsx(q,{size:16,className:"animate-spin"})," ",e.jsx("span",{children:"جاري تحديد الموقع..."})]});case"success":return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600",children:[e.jsx(K,{size:16})," ",e.jsx("span",{children:"تم تحديد الموقع بنجاح."})]});case"error":return e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-600",children:[e.jsx(V,{size:16})," ",e.jsx("span",{children:"فشل تحديد الموقع. سيتم الحفظ بدون إحداثيات."})]});default:return null}};return t?e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center",onClick:d,children:e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-lg shadow-xl p-8 w-full max-w-2xl mx-4",onClick:u=>u.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-slate-900 dark:text-white",children:"إضافة إدخال جديد لسجل الموقع"}),e.jsx("button",{onClick:d,className:"text-slate-500 hover:text-slate-800 dark:hover:text-slate-200",children:e.jsx(F,{size:24})})]}),e.jsxs("form",{onSubmit:f,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"صورة الموقع"}),e.jsxs("div",{className:"border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl h-64 flex flex-col items-center justify-center cursor-pointer hover:border-sky-500 transition-colors",onClick:()=>{var u;return(u=A.current)==null?void 0:u.click()},children:[e.jsx("input",{type:"file",accept:"image/*",ref:A,onChange:h,className:"hidden",required:!0}),o?e.jsx("img",{src:o,alt:"Preview",className:"object-contain h-full w-full rounded-xl"}):e.jsxs("div",{className:"text-center text-slate-500",children:[e.jsx($,{size:48,className:"mx-auto mb-2"}),e.jsx("p",{children:"انقر لرفع صورة"})]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"userNotes",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"ملاحظات (اختياري)"}),e.jsx("textarea",{id:"userNotes",value:s,onChange:u=>l(u.target.value),rows:3,placeholder:"أضف أي ملاحظات أو سياق إضافي للصورة...",className:"w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-sky-500"})]}),y&&e.jsx("p",{className:"text-red-500 text-sm mb-4",children:y}),e.jsx("div",{className:"mb-4 h-6",children:m()}),e.jsxs("div",{className:"flex justify-end gap-4",children:[e.jsx("button",{type:"button",onClick:d,className:"px-4 py-2 rounded-lg text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500",children:"إلغاء"}),e.jsx("button",{type:"submit",disabled:p||!n,className:"px-4 py-2 rounded-lg text-white bg-sky-600 hover:bg-sky-700 flex items-center gap-2 disabled:bg-slate-400",children:p?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white"}),e.jsx("span",{children:"جارٍ التحليل والحفظ..."})]}):e.jsxs(e.Fragment,{children:[e.jsx(H,{size:18}),e.jsx("span",{children:"حفظ وتحليل"})]})})]})]})]})}):null},ne=({workLog:t,schedule:a,onAddLog:r})=>{const[g,n]=c.useState(!1),[i,o]=c.useState({date:new Date().toISOString().split("T")[0],activitiesPerformed:"",manpowerCount:0,linkedTaskIds:[]}),x=()=>{i.activitiesPerformed.trim()&&(r(i),n(!1),o({date:new Date().toISOString().split("T")[0],activitiesPerformed:"",manpowerCount:0,linkedTaskIds:[]}))};return e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6",children:[e.jsxs("h3",{className:"text-xl font-bold mb-4 flex items-center gap-2",children:[e.jsx(E,{})," سجل العمل اليومي"]}),g?e.jsxs("div",{className:"space-y-4 bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg",children:[e.jsx("input",{type:"date",value:i.date,onChange:s=>o(k(j({},i),{date:s.target.value})),className:"w-full bg-gray-100 dark:bg-gray-800 p-2 rounded"}),e.jsx("textarea",{value:i.activitiesPerformed,onChange:s=>o(k(j({},i),{activitiesPerformed:s.target.value})),placeholder:"الأنشطة المنجزة اليوم...",rows:3,className:"w-full bg-gray-100 dark:bg-gray-800 p-2 rounded"}),e.jsx("input",{type:"number",value:i.manpowerCount,onChange:s=>o(k(j({},i),{manpowerCount:Number(s.target.value)})),placeholder:"عدد العمال",className:"w-full bg-gray-100 dark:bg-gray-800 p-2 rounded"}),e.jsx("select",{multiple:!0,value:i.linkedTaskIds.map(String),onChange:s=>o(k(j({},i),{linkedTaskIds:Array.from(s.target.selectedOptions,l=>Number(l.value))})),className:"w-full bg-gray-100 dark:bg-gray-800 p-2 rounded h-24",children:a.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>n(!1),className:"px-3 py-1 rounded bg-gray-200 dark:bg-gray-600 text-sm",children:"إلغاء"}),e.jsx("button",{onClick:x,className:"px-3 py-1 rounded bg-indigo-600 text-white text-sm",children:"حفظ"})]})]}):e.jsxs("button",{onClick:()=>n(!0),className:"w-full flex items-center justify-center gap-2 bg-indigo-100 text-indigo-700 font-semibold py-2 px-4 rounded-lg hover:bg-indigo-200 dark:bg-indigo-900/50 dark:text-indigo-300 dark:hover:bg-indigo-900",children:[e.jsx(_,{size:18}),e.jsx("span",{children:"إضافة سجل عمل جديد"})]}),e.jsx("div",{className:"mt-4 space-y-3 max-h-60 overflow-y-auto",children:t.sort((s,l)=>new Date(l.date).getTime()-new Date(s.date).getTime()).map(s=>e.jsxs("div",{className:"bg-gray-100 dark:bg-gray-900/50 p-3 rounded-md text-sm",children:[e.jsxs("p",{className:"font-semibold",children:[new Date(s.date).toLocaleDateString("ar-SA"),": ",e.jsx("span",{className:"font-normal",children:s.activitiesPerformed})]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["العمال: ",s.manpowerCount," | المهام المرتبطة: ",s.linkedTaskIds.length]})]},s.id))})]})},ie=({checklists:t,dailyActivities:a,onUpdateChecklists:r})=>{const[g,n]=c.useState(!1),i=()=>P(null,null,function*(){n(!0);try{const s=yield G(a);r([...t,...s])}catch(s){alert(`Failed to generate checklist: ${s.message}`)}finally{n(!1)}}),o=(s,l)=>{r(t.map(p=>p.id===s?k(j({},p),{status:l}):p))},x=t.reduce((s,l)=>((s[l.category]=s[l.category]||[]).push(l),s),{});return e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-bold flex items-center gap-2",children:[e.jsx(ee,{})," قوائم الفحص (QA/QC & HSE)"]}),e.jsxs("button",{onClick:i,disabled:g||!a,className:"flex items-center gap-2 bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg hover:bg-teal-700 text-sm disabled:bg-gray-400",children:[g?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}):e.jsx(se,{size:16}),e.jsx("span",{children:g?"...":"توليد قائمة لليوم"})]})]}),e.jsx("div",{className:"space-y-4 max-h-80 overflow-y-auto",children:["QA/QC","HSE"].map(s=>x[s]&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-indigo-600 dark:text-indigo-400 mb-2",children:s}),e.jsx("div",{className:"space-y-2",children:x[s].map(l=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 dark:bg-gray-900/50 p-2 rounded",children:[e.jsx("p",{className:"text-sm",children:l.text}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>o(l.id,"Pass"),className:`p-1 rounded-full ${l.status==="Pass"?"bg-green-500 text-white":"hover:bg-green-100"}`,children:e.jsx(te,{size:14})}),e.jsx("button",{onClick:()=>o(l.id,"Fail"),className:`p-1 rounded-full ${l.status==="Fail"?"bg-red-500 text-white":"hover:bg-red-100"}`,children:e.jsx(F,{size:14})}),e.jsx("button",{onClick:()=>o(l.id,"N/A"),className:`p-1 rounded-full ${l.status==="N/A"?"bg-gray-500 text-white":"hover:bg-gray-100"}`,children:e.jsx("span",{className:"text-xs font-bold",children:"N/A"})})]})]},l.id))})]},s))})]})},de=({entry:t})=>{const a=ae.parse(t.aiAnalysis);return e.jsxs("div",{className:"bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden",children:[e.jsx("img",{src:t.photoUrl,alt:`Site progress on ${t.date}`,className:"w-full h-64 object-cover"}),e.jsxs("div",{className:"p-6",children:[e.jsx("p",{className:"text-sm font-semibold text-sky-600 dark:text-sky-400",children:new Date(t.date).toLocaleDateString("ar-SA",{year:"numeric",month:"long",day:"numeric"})}),t.userNotes&&e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold text-slate-800 dark:text-slate-200",children:"ملاحظات المستخدم:"}),e.jsx("p",{className:"text-slate-600 dark:text-slate-300 whitespace-pre-wrap",children:t.userNotes})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h4",{className:"font-semibold text-slate-800 dark:text-slate-200",children:"تحليل الذكاء الاصطناعي:"}),e.jsx("div",{className:"prose prose-sm dark:prose-invert max-w-none mt-2",dangerouslySetInnerHTML:{__html:a}})]})]})]})},oe=({entries:t})=>{const[a,r]=c.useState(t[0]||null);if(t.length===0)return e.jsxs("div",{className:"text-center py-20 bg-white dark:bg-slate-800 rounded-xl shadow-md",children:[e.jsx(X,{size:64,className:"mx-auto text-slate-400 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-slate-700 dark:text-slate-300",children:"لا توجد إدخالات ذات موقع جغرافي"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mt-2",children:"أضف إدخالات جديدة مع تفعيل خدمة تحديد المواقع لعرضها على الخريطة."})]});const g=a?`https://www.google.com/maps/embed/v1/view?key=AIzaSyAK_UVp3OsRKnakSBiTOSp9mzkPioy7O3A&center=${a.latitude},${a.longitude}&zoom=18&maptype=satellite`:"";return e.jsxs("div",{className:"flex flex-col md:flex-row gap-8 bg-white dark:bg-slate-800 rounded-xl shadow-md overflow-hidden h-[75vh]",children:[e.jsx("div",{className:"w-full md:w-1/3 lg:w-1/4 h-1/3 md:h-full overflow-y-auto p-4 space-y-3 bg-slate-50 dark:bg-slate-900/50",children:t.map(n=>e.jsxs("button",{onClick:()=>r(n),className:`w-full text-right p-3 rounded-lg transition-all ${(a==null?void 0:a.id)===n.id?"bg-sky-100 dark:bg-sky-900 ring-2 ring-sky-500":"hover:bg-slate-100 dark:hover:bg-slate-700"}`,children:[e.jsx("img",{src:n.photoUrl,alt:n.userNotes,className:"w-full h-24 object-cover rounded-md mb-2"}),e.jsx("p",{className:"text-xs font-semibold text-sky-600 dark:text-sky-400",children:new Date(n.date).toLocaleDateString("ar-SA")}),e.jsx("p",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 truncate",children:n.userNotes||"لا توجد ملاحظات"})]},n.id))}),e.jsx("div",{className:"flex-grow h-2/3 md:h-full",children:a&&e.jsx("iframe",{width:"100%",height:"100%",style:{border:0},loading:"lazy",allowFullScreen:!0,src:g},a.id)})]})},je=({project:t,onUpdateSiteLog:a,onUpdateWorkLog:r,onUpdateChecklists:g,onUpdateSchedule:n})=>{const[i,o]=c.useState(!1),[x,s]=c.useState("execution"),{siteLog:l,workLog:p,checklists:v,schedule:y}=t.data,b=c.useMemo(()=>[...l||[]].sort((d,h)=>new Date(h.date).getTime()-new Date(d.date).getTime()),[l]),S=c.useMemo(()=>b.filter(d=>d.latitude!=null&&d.longitude!=null),[b]),C=c.useMemo(()=>{var h;return((h=[...p||[]].sort((f,m)=>new Date(m.date).getTime()-new Date(f.date).getTime())[0])==null?void 0:h.activitiesPerformed)||""},[p]),I=d=>{const h=k(j({},d),{id:le()});if(r(t.id,[...p||[],h]),h.linkedTaskIds.length>0){const f=y.map(m=>h.linkedTaskIds.includes(m.id)&&m.status!=="Done"?k(j({},m),{progress:Math.min(100,m.progress+10),status:"In Progress"}):m);n(t.id,f)}},w=()=>{window.print()},A=()=>{const d=b.map(m=>({التاريخ:new Date(m.date).toLocaleString("ar-SA"),"ملاحظات المستخدم":m.userNotes,"تحليل AI":m.aiAnalysis.replace(/<[^>]*>?/gm,""),"خط العرض":m.latitude,"خط الطول":m.longitude})),h=XLSX.utils.json_to_sheet(d),f=XLSX.utils.book_new();XLSX.utils.book_append_sheet(f,h,"Site Log"),XLSX.writeFile(f,`site_log_${t.name.replace(/\s/g,"_")}.xlsx`)},D=()=>{switch(x){case"execution":return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsx(ne,{workLog:p||[],schedule:y,onAddLog:I}),e.jsx(ie,{checklists:v||[],dailyActivities:C,onUpdateChecklists:d=>g(t.id,d)})]});case"visual":return b.length>0?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8",children:b.map(d=>e.jsx(de,{entry:d},d.id))}):e.jsxs("div",{className:"text-center py-20 bg-white dark:bg-slate-800 rounded-xl shadow-md",children:[e.jsx($,{size:64,className:"mx-auto text-slate-400 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-slate-700 dark:text-slate-300",children:"السجل فارغ"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 mt-2",children:"ابدأ بتوثيق تقدم المشروع عن طريق إضافة أول إدخال لك."})]});case"map":return e.jsx(oe,{entries:S})}};return e.jsxs("div",{className:"printable-area",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8 flex-wrap gap-4 no-print",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold text-slate-900 dark:text-white",children:"مركز التنفيذ الميداني"}),e.jsxs("p",{className:"mt-2 text-slate-600 dark:text-slate-400",children:["توثيق التقدم، تسجيل الأعمال اليومية، وإدارة الجودة والسلامة لمشروع: ",e.jsx("span",{className:"font-semibold",children:t.name})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:A,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(J,{size:18}),e.jsx("span",{children:"تصدير Excel"})]}),e.jsxs("button",{onClick:w,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(Y,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]}),e.jsxs("div",{className:"flex items-center gap-1 bg-slate-200 dark:bg-slate-700 p-1 rounded-lg",children:[e.jsx("button",{onClick:()=>s("execution"),className:`p-2 rounded-md ${x==="execution"?"bg-white dark:bg-slate-800 shadow-sm text-sky-600":"text-slate-500"}`,"aria-label":"Execution view",children:e.jsx(E,{size:18})}),e.jsx("button",{onClick:()=>s("visual"),className:`p-2 rounded-md ${x==="visual"?"bg-white dark:bg-slate-800 shadow-sm text-sky-600":"text-slate-500"}`,"aria-label":"Grid view",children:e.jsx(Z,{size:18})}),e.jsx("button",{onClick:()=>s("map"),className:`p-2 rounded-md ${x==="map"?"bg-white dark:bg-slate-800 shadow-sm text-sky-600":"text-slate-500"}`,"aria-label":"Map view",children:e.jsx(X,{size:18})})]}),e.jsxs("button",{onClick:()=>o(!0),className:"flex items-center gap-2 bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-sky-700",children:[e.jsx(_,{size:18}),e.jsx("span",{children:"إضافة سجل مرئي"})]})]})]}),D(),e.jsx(re,{isOpen:i,onClose:()=>o(!1),project:t,onUpdateSiteLog:a})]})};export{je as SiteTracker};
