var T=Object.defineProperty,$=Object.defineProperties;var B=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var U=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable;var A=(c,l,o)=>l in c?T(c,l,{enumerable:!0,configurable:!0,writable:!0,value:o}):c[l]=o,P=(c,l)=>{for(var o in l||(l={}))U.call(l,o)&&A(c,o,l[o]);if(O)for(var o of O(l))G.call(l,o)&&A(c,o,l[o]);return c},L=(c,l)=>$(c,B(l));import{r as i,j as e}from"./react-vendor-ITqvX6Xp.js";import{N as H,O as J,P as Q,a2 as K,al as V,q as W,am as Y,an as Z,a8 as ee,X as te}from"./icons-lib-Bt_-gcnY.js";import{v as _}from"./utils-lib-C_gzCXPI.js";import"./vendor-8CkhJSGZ.js";const E={Draft:{title:"مسودة",color:"bg-gray-500"},Submitted:{title:"مقدم",color:"bg-blue-500"},Approved:{title:"معتمد",color:"bg-yellow-500"},Paid:{title:"مدفوع",color:"bg-green-500"},Rejected:{title:"مرفوض",color:"bg-red-500"}},se=({isOpen:c,onClose:l,onSave:o,subcontractor:t})=>{const[p,k]=i.useState((t==null?void 0:t.name)||""),[g,f]=i.useState((t==null?void 0:t.trade)||""),[b,q]=i.useState((t==null?void 0:t.contactPerson)||""),[v,I]=i.useState((t==null?void 0:t.contactEmail)||""),[x,S]=i.useState((t==null?void 0:t.contactPhone)||""),w=r=>{r.preventDefault();const C={name:p,trade:g,contactPerson:b,contactEmail:v,contactPhone:x};o(t?L(P({},C),{id:t.id}):C),l()};return c?e.jsx("div",{className:"modal",style:{display:"block"},onClick:l,children:e.jsxs("div",{className:"modal-content p-6 max-w-lg",onClick:r=>r.stopPropagation(),children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:t?"تعديل مقاول":"إضافة مقاول باطن جديد"}),e.jsxs("form",{onSubmit:w,className:"space-y-4",children:[e.jsx("input",{type:"text",placeholder:"اسم الشركة",value:p,onChange:r=>k(r.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsx("input",{type:"text",placeholder:"التخصص (مثال: كهرباء)",value:g,onChange:r=>f(r.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsx("input",{type:"text",placeholder:"اسم جهة الاتصال",value:b,onChange:r=>q(r.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsx("input",{type:"email",placeholder:"البريد الإلكتروني",value:v,onChange:r=>I(r.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsx("input",{type:"tel",placeholder:"رقم الهاتف",value:x,onChange:r=>S(r.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx("button",{type:"button",onClick:l,className:"py-2 px-4 rounded-lg bg-gray-200 dark:bg-gray-600",children:"إلغاء"}),e.jsx("button",{type:"submit",className:"py-2 px-4 rounded-lg bg-indigo-600 text-white",children:"حفظ"})]})]})]})}):null},ae=({isOpen:c,onClose:l,onSave:o,invoice:t,subcontractorId:p,projectBoq:k})=>{const[g,f]=i.useState((t==null?void 0:t.invoiceNumber)||""),[b,q]=i.useState((t==null?void 0:t.date)||new Date().toISOString().split("T")[0]),[v,I]=i.useState((t==null?void 0:t.status)||"Draft"),[x,S]=i.useState((t==null?void 0:t.items)||[{id:_()}]),w=i.useMemo(()=>x.reduce((a,d)=>a+(d.total||0),0),[x]),r=(a,d,h)=>{const n=[...x],N=P({},n[a]);if(N[d]=h,d==="boqItemId"){const X=k.find(s=>s.id===h);X&&(N.description=X.item,N.unitPrice=X.unitPrice)}(d==="executedQuantity"||d==="unitPrice")&&(N.total=(N.executedQuantity||0)*(N.unitPrice||0)),n[a]=N,S(n)},C=()=>S([...x,{id:_()}]),M=a=>S(x.filter((d,h)=>h!==a)),j=a=>{a.preventDefault();const d=x.filter(n=>n.description&&n.executedQuantity&&n.unitPrice!=null);if(d.length===0){alert("Please add at least one valid item to the invoice.");return}const h={invoiceNumber:g,date:b,status:v,items:d,totalAmount:w,subcontractorId:p};o(t?L(P({},h),{id:t.id}):h),l()};return c?e.jsx("div",{className:"modal",style:{display:"block"},onClick:l,children:e.jsxs("div",{className:"modal-content p-6 max-w-4xl",onClick:a=>a.stopPropagation(),children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:t?"تعديل المستخلص":"مستخلص جديد"}),e.jsxs("form",{onSubmit:j,children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsx("input",{type:"text",placeholder:"رقم المستخلص",value:g,onChange:a=>f(a.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsx("input",{type:"date",value:b,onChange:a=>q(a.target.value),required:!0,className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"}),e.jsx("select",{value:v,onChange:a=>I(a.target.value),className:"w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg",children:Object.entries(E).map(([a,d])=>e.jsx("option",{value:a,children:d.title},a))})]}),e.jsx("div",{className:"max-h-64 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100 dark:bg-gray-800 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"p-2 text-right",children:"بند المقايسة (اختياري)"}),e.jsx("th",{className:"p-2 text-right",children:"الوصف"}),e.jsx("th",{className:"p-2 text-right",children:"الكمية المنفذة"}),e.jsx("th",{className:"p-2 text-right",children:"سعر الوحدة"}),e.jsx("th",{className:"p-2 text-right",children:"الإجمالي"}),e.jsx("th",{className:"p-2"})]})}),e.jsx("tbody",{children:x.map((a,d)=>{var h;return e.jsxs("tr",{className:"border-b dark:border-gray-700 last:border-0",children:[e.jsx("td",{className:"p-1",children:e.jsxs("select",{value:a.boqItemId,onChange:n=>r(d,"boqItemId",n.target.value),className:"w-full bg-gray-50 dark:bg-gray-900 p-1 rounded",children:[e.jsx("option",{value:"",children:"-- اختر --"}),k.map(n=>e.jsx("option",{value:n.id,children:n.item},n.id))]})}),e.jsx("td",{className:"p-1",children:e.jsx("input",{type:"text",placeholder:"وصف البند",value:a.description||"",onChange:n=>r(d,"description",n.target.value),required:!0,className:"w-full bg-gray-50 dark:bg-gray-900 p-1 rounded"})}),e.jsx("td",{className:"p-1",children:e.jsx("input",{type:"number",placeholder:"الكمية",value:a.executedQuantity||"",onChange:n=>r(d,"executedQuantity",Number(n.target.value)),required:!0,className:"w-full bg-gray-50 dark:bg-gray-900 p-1 rounded"})}),e.jsx("td",{className:"p-1",children:e.jsx("input",{type:"number",placeholder:"السعر",value:a.unitPrice||"",onChange:n=>r(d,"unitPrice",Number(n.target.value)),required:!0,className:"w-full bg-gray-50 dark:bg-gray-900 p-1 rounded"})}),e.jsx("td",{className:"p-1 font-mono",children:((h=a.total)==null?void 0:h.toLocaleString())||0}),e.jsx("td",{className:"p-1 text-center",children:e.jsx("button",{type:"button",onClick:()=>M(d),children:e.jsx(te,{size:16,className:"text-red-500"})})})]},a.id)})})]})}),e.jsx("button",{type:"button",onClick:C,className:"text-sm text-indigo-600 font-semibold mt-2",children:"إضافة بند +"}),e.jsxs("div",{className:"text-left font-bold text-lg mt-4",children:["الإجمالي: ",w.toLocaleString("ar-SA")," SAR"]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t mt-4",children:[e.jsx("button",{type:"button",onClick:l,className:"py-2 px-4 rounded-lg bg-gray-200 dark:bg-gray-600",children:"إلغاء"}),e.jsx("button",{type:"submit",className:"py-2 px-4 rounded-lg bg-indigo-600 text-white",children:"حفظ المستخلص"})]})]})]})}):null},ce=({project:c,onUpdateSubcontractors:l,onUpdateInvoices:o})=>{const{subcontractors:t,subcontractorInvoices:p,financials:k}=c.data,[g,f]=i.useState(t.length>0?t[0].id:null),[b,q]=i.useState(""),[v,I]=i.useState(!1),[x,S]=i.useState(null),[w,r]=i.useState(!1),[C,M]=i.useState(null),j=i.useMemo(()=>{if(!b)return t;const s=b.toLowerCase();return t.filter(u=>u.name.toLowerCase().includes(s)||u.trade.toLowerCase().includes(s)||u.contactPerson.toLowerCase().includes(s))},[t,b]);i.useEffect(()=>{!g||j.some(s=>s.id===g)||f(j.length>0?j[0].id:null)},[j,g]);const a=i.useMemo(()=>j.find(s=>s.id===g),[j,g]),d=i.useMemo(()=>p.filter(s=>s.subcontractorId===g),[p,g]),h=s=>{let u;if("id"in s)u=t.map(y=>y.id===s.id?s:y);else{const y=L(P({},s),{id:_()});u=[...t,y],f(y.id)}l(c.id,u)},n=s=>{let u;"id"in s?u=p.map(y=>y.id===s.id?s:y):u=[...p,L(P({},s),{id:_()})],o(c.id,u)},N=()=>window.print(),X=()=>{const s=t.map(m=>({ID:m.id,الاسم:m.name,التخصص:m.trade,"جهة الاتصال":m.contactPerson,"البريد الإلكتروني":m.contactEmail,الهاتف:m.contactPhone})),u=p.map(m=>{const z=t.find(R=>R.id===m.subcontractorId);return{"ID المستخلص":m.id,"رقم المستخلص":m.invoiceNumber,المقاول:z==null?void 0:z.name,التاريخ:m.date,الحالة:E[m.status].title,الإجمالي:m.totalAmount}}),y=XLSX.utils.json_to_sheet(s),F=XLSX.utils.json_to_sheet(u),D=XLSX.utils.book_new();XLSX.utils.book_append_sheet(D,y,"Subcontractors"),XLSX.utils.book_append_sheet(D,F,"Invoices"),XLSX.writeFile(D,`subcontractors_${c.name.replace(/\s/g,"_")}.xlsx`)};return e.jsxs("div",{className:"printable-area",children:[e.jsxs("header",{className:"flex justify-between items-center mb-8 flex-wrap gap-4 no-print",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"إدارة مقاولي الباطن"}),e.jsxs("p",{className:"text-gray-500 mt-1",children:["متابعة المستخلصات والكميات المنفذة لمشروع: ",c.name]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:X,className:"flex items-center gap-2 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700",children:[e.jsx(H,{size:18}),e.jsx("span",{children:"تصدير Excel"})]}),e.jsxs("button",{onClick:N,className:"flex items-center gap-2 bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600",children:[e.jsx(J,{size:18}),e.jsx("span",{children:"طباعة / PDF"})]}),e.jsxs("button",{onClick:()=>{S(null),I(!0)},className:"flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700",children:[e.jsx(Q,{size:18}),e.jsx("span",{children:"إضافة مقاول"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-8",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white dark:bg-gray-900/50 p-4 rounded-xl shadow-sm border dark:border-gray-800 no-print",children:[e.jsx("h3",{className:"font-bold mb-4",children:"قائمة المقاولين"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(K,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"بحث...",value:b,onChange:s=>q(s.target.value),className:"w-full bg-gray-100 dark:bg-gray-800 rounded-lg py-2 pr-10 pl-4 text-sm focus:outline-none focus:ring-1 focus:ring-indigo-500"})]}),e.jsxs("div",{className:"space-y-2 max-h-[60vh] overflow-y-auto",children:[j.map(s=>e.jsxs("button",{onClick:()=>f(s.id),className:`w-full text-right p-3 rounded-lg flex items-center gap-3 ${g===s.id?"bg-indigo-100 dark:bg-indigo-900":"hover:bg-gray-100 dark:hover:bg-gray-800"}`,children:[e.jsx("div",{className:"bg-indigo-200 dark:bg-indigo-800 p-2 rounded-full",children:e.jsx(V,{size:16})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-sm",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.trade})]})]},s.id)),j.length===0&&e.jsx("p",{className:"text-center text-sm text-gray-500 py-4",children:"لا توجد نتائج مطابقة."})]})]}),e.jsx("div",{className:"lg:col-span-3",children:a?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border dark:border-gray-800",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:a.name}),e.jsx("p",{className:"text-gray-500 mb-4",children:a.trade}),e.jsxs("div",{className:"flex flex-wrap gap-x-6 gap-y-2 text-sm",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(W,{size:14})," ",a.contactPerson]}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Y,{size:14})," ",a.contactEmail]}),e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Z,{size:14})," ",a.contactPhone]})]})]}),e.jsxs("div",{className:"bg-white dark:bg-gray-900/50 p-6 rounded-xl shadow-sm border dark:border-gray-800",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"المستخلصات"}),e.jsxs("button",{onClick:()=>{M(null),r(!0)},className:"no-print flex items-center gap-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 text-sm",children:[e.jsx(Q,{size:16}),e.jsx("span",{children:"مستخلص جديد"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-right text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b dark:border-gray-700",children:[e.jsx("th",{className:"p-2",children:"الرقم"}),e.jsx("th",{className:"p-2",children:"التاريخ"}),e.jsx("th",{className:"p-2",children:"الإجمالي"}),e.jsx("th",{className:"p-2",children:"الحالة"}),e.jsx("th",{className:"p-2 no-print"})]})}),e.jsx("tbody",{children:d.map(s=>e.jsxs("tr",{className:"border-b dark:border-gray-700 last:border-0",children:[e.jsx("td",{className:"p-2 font-medium",children:s.invoiceNumber}),e.jsx("td",{className:"p-2",children:s.date}),e.jsxs("td",{className:"p-2 font-mono",children:[s.totalAmount.toLocaleString("ar-SA")," SAR"]}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full text-white ${E[s.status].color}`,children:E[s.status].title})}),e.jsx("td",{className:"p-2 no-print",children:e.jsx("button",{onClick:()=>{M(s),r(!0)},children:e.jsx(ee,{size:14})})})]},s.id))})]})})]})]}):e.jsx("div",{className:"flex items-center justify-center h-64 bg-gray-100 dark:bg-gray-800 rounded-xl",children:e.jsx("p",{children:"الرجاء اختيار مقاول لعرض التفاصيل"})})})]}),e.jsx(se,{isOpen:v,onClose:()=>I(!1),onSave:h,subcontractor:x}),w&&g&&e.jsx(ae,{isOpen:w,onClose:()=>r(!1),onSave:n,invoice:C,subcontractorId:g,projectBoq:k})]})};export{ce as SubcontractorManager};
